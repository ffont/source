# Source, a Freesound-powered hardware sampler


## Building Source

Source is implemented as a JUCE audio plug-in and can be edited and built using standard JUCE workflows. The first step is to clone this repository and init the submodules. Then, different steps apply to build Source for desktop computers or for the ELK platform (see below).

```
git clone https://github.com/ffont/source.git && cd source && git submodule update --init
```


### Build standalone/plugin for desktop (macOS)

For development purposes (or to run Source in a desktop computer insead of the ELK platform), you can use the XCode project files generated by Projucer. You can also generate exporters for other platforms using Projucer, but I only tested macOS.

Alternatively, you can also use the Python *Fabric 2* script (see below) provided im the `scripts` folder. Do it like that:

```
cd scripts
fab compile-macos
```

This will create *Release* versions of Source (VST3, VST2, AU and Standalone) ready to work on the mac.

**NOTE**: macOS build targets include a *pre-build shell script* phase which generates the `BinaryData.h/.cpp` files needed for the plugin to include up-to-date resources (mainly `index.html`). These files are generated with the `BinaryBuilder` util provided in the JUCE codebase. `BinaryBuilder` is compiled as part of the build process so you should encounter no issues with that.

**NOTE 2**: macOS build targets require `openssl` to implement the HTTPS sevrer that hosts the plugin UI. Install by using `brew install openssl`.

**NOTE 3**: Source requires a Freesound API key to connect to Freesound. You should make an account in Freesound (if you don't have one) and go to [this URL to generate an APi key](https://freesound.org/apiv2/apply). Then you should edit the file `/source/SourceSampler/Source/api_key.example.h`, add your key, and then then save and rename the file to `/source/SourceSampler/Source/api_key.h`.

**NOTE 4**: For development you might need to edit the `SourceSampler.jucer` Projucer file. To do that, you need a compatible version of Projucer installed. You can compile it (for macOS) from JUCE source files using a the *Fabric 2* Python script running: `fab compile-projucer-macos`. The generated executable will be in `/source/SourceSampler/3rdParty/JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app`.

**NOTE 5**: it should be very easy to adapt these instructions for windows or linux. You'll basically need to create an exporter for these other platforms an make small changes to compile `BinaryBuilder`, `Projucer` and install/link the dependencies.


### Build plugin for ELK platform

To build Source for ELK Audio OS you need to cross-compile it from your development computer. To do that, I use a Docker-based solution on macOS. The instructions here are therefore for cross-compiling from macOS and using Docker. For cross-compilation from Linux it should be simpler and you should refer to the ELK docs.

To do the cross compilation (and also deployment to the board) I prepared a Python script using [Fabric 2](http://www.fabfile.org) so I assume you have a Python 3 interpreter installed in your system with the Fabric 2 package installed (`pip install fabric` should do it).


#### Prepare ELK development SDK

The first thing to do is to prepare the ELK development SDK Docker image following the [instrucitons here](https://github.com/elk-audio/elkpi-sdk/blob/master/running_docker_container_on_macos.md). You need to run steps 1 to 3, no need to run the toolchain when everything installed.


#### Do the cross-compilation

With all this in place, you should be able to cross-compile Source for ELK in a very similar way as you would do it for the desktop, using the Fabric script:

```
cd scripts
fab compile-elk
```

(if you need a debug build, you can use `fab compile-elk-debug`)

This will take a while, specially the first time it runs. When it finished, it should have generated a `SourceSampler.so` file in `source/Builds/ELKAudioOS/build/SourceSampler.vst3/Contents/arm64-linux/` which is the VST3 plugin that you can run in ELK platform.

**NOTE**: the build script for the cross compilation includes a step which generates the `BinaryData.h/.cpp` files needed for the plugin to include up-to-date resources (mainly `index.html`). This is run in the host machine and not in the Docker container. For this step to succeed, you need to compile the  `BinaryBuilder` util provided by JUCE. You can compile that using the project files you'll find in `/source/SourceSampler/3rdParty/JUCE/extras/BinaryBuilder/Builds/` or by running `fab compile-binary-builder-macos`.


#### Loading the built plugin in the ELK board

Instructions for this section still need to be added.


### Note about JUCE version used for Source

The current version of Source uses JUCE 6 which has native support for VST3 plugins in Linux and for headless plugins. Therefore, unlike previous version of Source, we don't need any patched version of JUCE and we can simply use the official release :)


## Running Source in the ELK platform (with Blackboard hat)

### Configure auto-start

Follow official ELK instructions here: https://elk-audio.github.io/elk-docs/html/documents/working_with_elk_board.html#configuring-automatic-startup

1) Modify `sushi` service (`/lib/systemd/system/sushi.service`) to point to `/udata/source/app/source_sushi_config.json` and add restart policy. Change lines:

```
[Service]
Type=simple
RemainAfterExit=no
WorkingDirectory=/udata/
Environment=LD_LIBRARY_PATH=/usr/xenomai/lib
ExecStart=/usr/bin/sushi -r --multicore-processing=3 -c /udata/source/app/source_sushi_config.json
User=mind
Restart=always
RestartSec=3
```

2) Modify `sensei` service (`/lib/systemd/system/sensei.service`) to point to `/udata/source/app/source_sensei_config.json`. Change line:

```
Environment=LD_LIBRARY_PATH=/usr/xenomai/lib
ExecStart=/usr/bin/sensei -f /udata/source/app/source_sensei_config.json
```

3) Create new service for python server at `/lib/systemd/system/source.service` (use `sudo`). This server is used as the "glue" app which will run the HTTP server as well as control hardware stuff (display, LEDs, etc) and communicate with the plugin running in sushi using OSC messages. The server 
also takes care of downloading sounds as it seems to be much faster to do it from outside sushi.

```
[Unit]
Description=source glue app
After=sensei.service

[Service]
Type=simple
RemainAfterExit=no
WorkingDirectory=/udata/source/app/
ExecStart=python3 main
User=mind
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

4) Enable `sushi`, `sensei`, and `source` services

```
sudo systemctl enable sushi
sudo systemctl enable sensei
sudo systemctl enable source
```

Now both services will start automatically on start up. You can still use `./start` to test new versions because the previous processes will be killed.

When running from startup, you can check std out logs with:

```
sudo journalctl -fu sushi
sudo journalctl -fu sensei
sudo journalctl -fu source
```

### Give more sudo permissions to "mind" user

To run source, user `mind` needs to have `sudo` control without entering password. This is mainly because of the `collect_system_stats` routine called in the `main` glue app. However, it looks like wihtout having sudo capabilities,
running `sensei` might also fail. To add sudo capabilities:

 * switch to user `root` (`sudo su`)
 * edit `/etc/sudoers` to add the line `mind ALL=(ALL) NOPASSWD: ALL` in the *User privilege specification* AND comment the line `# %sudo ALL=(ALL) ALL`. **NOTE**: this gives too many permissions to `mind` user and should be fixed to give only what is needed.
    
    
## Licenses

Source is released under the **GPLv3** open source software license (see [LICENSE](https://github.com/ffont/source/blob/master/LICENSE) file) with the code being available at  [https://github.com/ffont/source](https://github.com/ffont/source). Source uses the following open source software libraries: 

* [juce](https://juce.com), available under GPLv3 license ([@76910b0](https://github.com/juce-framework/JUCE/tree/b8206e3604ebaca64779bf19f1613c373b9adf4f), v6.0.4)
* [cpp-httplib](https://github.com/yhirose/cpp-httplib), available under MIT license ([@3da4a0a](https://github.com/yhirose/cpp-httplib/tree/3da4a0a))
* [ff_meters](https://github.com/ffAudio/ff_meters), available under BSD 3 clause license ([@71e05b8](https://github.com/ffAudio/ff_meters/commit/71e05b8f93ec3643fc7268b8da65d7b98bdefdf8))

