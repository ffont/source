# Source, a hardware Freesound-powered sampler


## Building Source

Source is implemented as a JUCE audio plug-in and can be edited and built using standard JUCE workflows. The first step is to clone this repository and init the submodules. Then, different steps apply to build Source for desktop computers or for the ELK platform (see below).

```
git clone https://github.com/ffont/source.git && cd source && git submodule update --init
```


### Build standalone/plugin for desktop

For development purposes (or to run Source in a desktop computer insead of the ELK platform), you can use the XCode project files generated by Projucer. You can also generate exporters for other platforms using Projucer, but I only tested macOS.

Alternatively, you can also use the Python *Fabric 2* script (see below) provided im the `scripts` folder. Do it like that:

```
cd scripts
fab compile-macos
```

This will create *Release* versions of Source (VST3, VST2, AU and Standalone) ready to work on the mac.


### Build plugin for ELK platform

To build Source for ELK Audio OS you need to cross-compile it from your development computer. To do that, I use a Docker-based solution on macOS. The instructions here are therefore for cross-compiling from macOS and using Docker. For cross-compilation from Linux it should be simpler and you should refer to the ELK docs.

To do the cross compilation (and also deployment to the board) I prepared a Python script using [Fabric 2](http://www.fabfile.org) so I assume you have a Python 3 interpreter installed in your system with the Fabric 2 package installed (`pip install fabric` should do it).


#### Prepare ELK development SDK

The first thing to do is to prepare the ELK development SDK Docker image following the [instrucitons here](https://github.com/elk-audio/elkpi-sdk/blob/master/running_docker_container_on_macos.md). You need to run steps 1 to 3, no need to run the toolchain when everything installed.


#### Preparing some code dependencies

Source needs to be built as a VST2 plugin, meaning that you need the VST2 SDK installed in your computer. This is because the JUCE version used (5.4.7), does not support building VST3 plugins for Linux. The Python script used to build Source will try to mount the VST2 SDK in the Docker container so it can be used for compilation. The script will search for a folder named `VST_SDK` (the SDK) at the same directory level where the `source` folder is (if needed, you can edit this in `fabfile.py`). You should find a copy of the VST2 SDK and place it in the corresponding directory.


#### Do the cross-compilation

With all this in place, you should be able to cross-compile Source for ELK in a very similar way as you would do it for the desktop, using the Fabric script:

```
cd scripts
fab compile-elk
```

This will take a while, specially the first time it runs. When it finished, it should have generated an `SourceSampler.so` file in `source/Builds/ELKAudioOS/build/` which is the VST2 plugin that you can run in ELK platform.


#### Loading the built plugin in the ELK board

Instructions for this section still need to be added.


### Note about JUCE version used for Source

To build Source for the ELK platform Source it needs a custom version of JUCE which is patched to remove some graphical dependencies. In particular, we use a patched version of JUCE 5.4.7 which can be found in my [own fork of JUCE](https://github.com/ffont/JUCE_ELK) (a branch named [`juce_547_76910b0eb_ELK`](https://github.com/ffont/JUCE_ELK/tree/juce_547_76910b0eb_ELK)). The patch basically cosists in adding a number of `#if/#endif` to avoid using graphical libraries not present in ELK cross-compilation toolchain. I basically ported the [official patch proposed by ELK for JUCE version 5.4.5](https://github.com/juce-framework/JUCE/compare/master...elk-audio:mind/headless_plugin_client_next) to JUCE 5.4.7. The patched JUCE version can be used to build macOS version normally.

The custom JUCE patch is included as a submodule of this repository (`source/SourceSampler/3rdParty/JUCE_ELK`) and is already configured in the Projucer file. For conveniency, the standard JUCE version (at the same commit as the patched one) is also included as a submodule (`source/SourceSampler/3rdParty/JUCE`), but is not really used anywhere.

As far as I know, JUCE 6 is not yet supported by ELK, so we're using 5.4.7 here. Once JUCE 6 becomes supported, we won't probably need the cusotm patch (because JUCE 6 supports headless plugins) and also we won't need the VST2 SDK anymore because JUCE 6 can build VST3 plugins on Linux platforms.

### Auto-start notes for ELK platform

Follow official ELK instructions here: https://elk-audio.github.io/elk-docs/html/documents/working_with_elk_board.html#configuring-automatic-startup

1) Modify `sushi` service to point to `/home/mind/source_sushi_config.json`

2) Create new service for python server at `/lib/systemd/system/source-server.service` (use `sudo`). This server is used to download audio files outside the plugin because it seems to be much much faster this way.

```
[Unit]
Description=source web server
After=load-drivers.service

[Service]
Type=simple
RemainAfterExit=yes
WorkingDirectory=/home/mind/
ExecStart=python app.py
User=mind

[Install]
WantedBy=multi-user.target
```

3) Enable `sushi` and `source-server` services

```
sudo systemctl enable sushi
sudo systemctl enable source-server
```

Now both services will start automatically on start up. You can still use `start.sh` to test new versions because the previous processes will be killed.

When running from startup, you can check std out logs with:

```
sudo journalctl -fu sushi
sudo journalctl -fu source-server
```
    