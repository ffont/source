<!DOCTYPE html>
<html>

<head>
    <title>Source, a Freesound Commmunity Sampler</title>
    <script src="./dist/mainBF.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.0/nouislider.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Distressed&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&amp;display=swap" rel="stylesheet" />
    <script>

        $(function () {
            $(".knob-1").knob({
                'min': 0,
                'max': 1,
                'step': 0.01,
                'width': 45,
                'height': 45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset': 180,
                'fgColor': 'purple',
                'bgColor': '#dad9d9',
                'font': 'var(--font-default)',
                'change': function (v) {
                    ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                    if (adsrList.includes(this['$'][0]['id'])) {
                        drawAdsrEnvelope();
                    }
                }
            });

            $(".knob-reverb").knob({
                'min': 0,
                'max': 1,
                'step': 0.01,
                'width': 45,
                'height': 45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset': 180,
                'fgColor': 'purple',
                'bgColor': '#dad9d9',
                'font': 'var(--font-default)',
                'change': function (v) {
                    //Set reverb parameter to the new value
                    reverbParams[this['$'][0]['id']] = v;
                    ss.setReverbParameters();
                }
            });

            $(".knob-100").knob({
                'min': 0,
                'max': 100,
                'step': 0.01,
                'width': 45,
                'height': 45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset': 180,
                'fgColor': 'purple',
                'bgColor': '#dad9d9',
                'change': function (v) {
                    ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                }
            });


            $(".knob-12").knob({
                'min': -12,
                'max': 12,
                'step': 0.01,
                'width': 45,
                'height': 45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset': 180,
                'fgColor': 'purple',
                'bgColor': '#dad9d9',
                'change': function (v) {
                    ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                }
            });

            $(".knob-2000").knob({
                'min': 10,
                'max': 20000,
                'step': 1,
                'width': 45,
                'height': 45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset': 180,
                'fgColor': 'purple',
                'bgColor': '#dad9d9',
                'change': function (v) {
                    ss.setSoundParameter(this['$'][0]['id'], v, 0, 1)
                }
            });
        });



        let ss = undefined;  // Will keep source plugin state and has util methods to interact with it
        let httpPort = undefined;
        let useHttps = undefined;
        let hostname = undefined;

        //Define a global selected sound
        var selectedSoundUUID = null;

        //Sound list for play and remove
        let playStopSoundList = [];

        //Midi note list to stop previous one
        let loopTriggerMidiOnOffSet = new Set();
        let midiOnOffList = [];

        //ADSR lists
        let adsrList = ["attack", "decay", "release", "sustain", "filterAttack", "filterDecay", "filterRelease", "filterSustain"]
        let launchModes = ['default', 'loop', 'loopfb'];
        let gateTriggerModes = ['gate', 'trigger'];
        let adsrModes = ['filter', 'amplitude'];
        let modVelocityModes = ['modulation', 'velocity'];
        //Reverb parameters
        let reverbParams = { 'roomSize': 0, 'damping': 0, 'wetLevel': 0, 'dryLevel': 0, 'width': 0, 'freezeMode': 0 }

        //Knob parameters
        let knobParameterNamesAmp = ["attack", "decay", "sustain", "release", "gain", "pan",
            "mod2CutoffAmt", "mod2GainAmt", "mod2PitchAmt", "vel2CutoffAmt", "vel2GainAmt"]
        let knobParameterNamesFilter = ["filterAttack", "filterDecay", "filterRelease", "filterCutoff", "filterRessonance",
            "mod2CutoffAmt", "mod2GainAmt", "mod2PitchAmt", "vel2CutoffAmt", "vel2GainAmt"]
        //ADSR initial dictionary
        let DefaultParams = {
            attackTime: 0.1,
            decayTime: 0.1,
            sustainLevel: 0.1,
            releaseTime: 0.1,
            gateTime: 1,
            peakLevel: 1,
            epsilon: 0.001,
            attackCurve: "exp",
            decayCurve: "exp",
            releaseCurve: "exp",
        };

        //Wavecolor
        var wavesurferColor = 'purple';

        var adsrBackgroundColor = '#f2f1f1';


        var expStrength = 2;  // For sliders

        window.AudioContext = window.AudioContext || window.webkitAudioContext; // Audio context used for loading audio for drawing waveforms
        const audioContext = new AudioContext();

        let lastUIAction = 0;

        var wavesurfer = null;

        var slider = null;
        var singleSlider = null;
        var launchSlider = null;

        var newInnerBoxBorder = null;

        document.addEventListener("DOMContentLoaded", function () {

            // Main funciont: reads some configuration properties form the URL and starte the StateSynchronizer
            // Once the StateSyncronizer is started, it will start to receive updates when changes happen in
            // the plugin's state. These updates will triger renders of appropriate parts of the UI.
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            // If hostname is passed as a parameter, use it for WS and HTTP communications
            // Otherwise set it to the hostname of the current location
            if (urlParams.get('hostname') !== null) {
                hostname = urlParams.get('hostname');
            } else {
                if (location.hostname !== "") {
                    hostname = location.hostname;
                } else {
                    hostname = 'localhost';
                }
            }

            // Get websockets/http connection config parameters (or use defaults)
            if (urlParams.get('wsPort') !== null) {
                wsPort = urlParams.get('wsPort');
            } else {
                wsPort = "8125";
            }
            if (urlParams.get('useWss') !== null) {
                useWss = urlParams.get('useWss') == '1';
            } else {
                useWss = false;
            }
            if (urlParams.get('httpPort') !== null) {
                httpPort = urlParams.get('httpPort');
            } else {
                httpPort = "8124";
            }
            useHttps = useWss;


            // Start state synchronizer
            ss = new Core.StateSynchronizer(wsPort, useWss);



        });

        // Util methods

        function updateOctave(obj) {
            var octaveVal = obj.value;
            var keyboardParent = document.getElementById('keyboard');
            var keyboardOctaveVal = keyboardParent.children[0].textContent.split("")[1];
            for (var i = 0; i < keyboardParent.children.length; i++) {
                keyboardParent.children[i].id = 12 * (parseInt(octaveVal) + 2) + i;
            }

            keyboardParent.children[0].children[0].textContent = "C" + octaveVal;
            keyboardParent.children[12].children[0].textContent = "C" + (parseInt(octaveVal) + 1);

        }


        function sendMidiMessage(obj) {

            if (obj) {
                var midiNote = obj.id;

                var launchMode = $("#outer-box-keyboard > #inner-box-launch > p").text();
                var loopMode = $('#outer-box-launch > #inner-box-launch > p').text();
                //If mode is gate, the sound should stop as soon as key is released
                var int00 = 0;
                if (launchMode === "gate") {
                    $('#' + obj.id).mousedown(function () {
                        ss.sendMidiNoteOn(midiNote);
                        int00 = setInterval(function () { console.log('hold?'); }, 50);
                    }).mouseup(function () {
                        clearInterval(int00);
                        ss.sendMidiNoteOff(midiNote);
                    });

                } else {
                    //If trigger+loop is selected, the sounds are stopped when the key is hit twice

                    if (loopTriggerMidiOnOffSet.has(midiNote)) {
                        //Stop that loop sound
                        ss.sendMidiNoteOff(midiNote);
                        //Remove that sound from the midionofflist
                        loopTriggerMidiOnOffSet.delete(midiNote);
                        if (['loop', 'loopfb'].includes(loopMode)) {
                            $('#' + midiNote).removeClass('flash');
                        }
                    } else {
                        //Add new sound MIDI note
                        loopTriggerMidiOnOffSet.add(midiNote);
                        // Start playing that sound
                        ss.sendMidiNoteOn(midiNote);
                        if (['loop', 'loopfb'].includes(loopMode)) {
                            $('#' + midiNote).addClass('flash');
                        }

                    }
                    //If it's not loop and only trigger, play until the end
                    //But if another key is hit, just stop the previous sound
                }
            } else {
                console.log('not obj');
            }
        }

        function updateGlobalSoundUUID() {
            //Update the global sound UUID
            selectedSoundUUID = $("select#sound-dropdown option").filter(':selected').data('uuid');

            //Draw the ADSR Envelope for the selected sound
            drawAdsrEnvelope();

            //Draw the waveform for the selected sound
            drawSoundWaveform();

            //Update the sliders with the new sound
            updateAllParameterElements();

            //Update the launch mode
            updateLaunchMode();

            //Set midi root of the selected sound
        };

        function updateAllParameterElements() {
            updateKnobElements();

        }

        function updateKnobElements() {
            //A workaround for filter/amplitude ADSR selection
            if ($('#attack') !== null) {
                var iterateList = knobParameterNamesAmp;
            } else {
                var iterateList = knobParameterNamesFilter;
            }
            for (var i = 0; i < iterateList.length; i++) {
                var element = iterateList[i];
                var elementVal = ss.getSoundParameterValue(selectedSoundUUID, element);
                $('#' + element).val(elementVal).trigger('change');
            }
            if ($('#filterADSR2CutoffAmt').length == 0) {
                updateAmplitudeADSR();
            } else {
                updateFilterADSR();
            }
        }

        function updateFilterADSR() {
            var iterateList = ['filterAttack', 'filterDecay', 'filterRelease', 'filterSustain', 'filterADSR2CutoffAmount', 'filterCutoff', 'filterRessonance'];
            for (var i = 0; i < iterateList.length; i++) {
                var element = iterateList[i];
                var elementVal = ss.getSoundParameterValue(selectedSoundUUID, element);
                $('#' + element).val(elementVal).trigger('change');
            }

        }

        function updateAmplitudeADSR() {
            var iterateList = ['attack', 'decay', 'release', 'sustain', 'pan', 'gain'];
            for (var i = 0; i < iterateList.length; i++) {
                var element = iterateList[i];
                var elementVal = ss.getSoundParameterValue(selectedSoundUUID, element);
                $('#' + element).val(elementVal).trigger('change');
            }
        }


        function updateAmplitudeADSR() {
            var iterateList = ['attack', 'decay', 'release', 'sustain'];
            for (var i = 0; i < iterateList.length; i++) {
                var element = iterateList[i];
                var elementVal = ss.getSoundParameterValue(selectedSoundUUID, element);
                $('#' + element).val(elementVal).trigger('change');
            }
        }


        window.onload = function () {

            var rangeInput = document.getElementById('q-par');
            rangeInput.addEventListener('click', function () {
                const isInput = event.target.nodeName === 'INPUT';
                var rangeTextName = event.target.id;
                var rangeText = document.getElementById('range-text-' + rangeTextName);
                if (rangeText !== null) {
                    let newVal = event.target.value;
                    rangeText.innerHTML = newVal; //Set range text equal to input position



                }
            })
            slider = $('.double-slider');

            noUiSlider.create(slider[0], {
                start: [0, 90],
                step: 1,
                connect: true,
                tooltips: true,
                format: wNumb({ decimals: 0 }),
                range: {
                    'min': 1,
                    'max': 100,
                },

            });


            singleSlider = $('.single-slider');

            noUiSlider.create(singleSlider[0], {
                start: 1,
                step: 1,
                connect: true,
                tooltips: true,
                format: wNumb({ decimals: 0 }),
                range: {
                    'min': 1,
                    'max': 20,
                },

            });

        }


        function switchColorModes(obj) {

            ss.setMidiInChannel(1);

            if ($('.mode-button').attr('value') === "0") {
                var newVal = "1";
                var newBackground = '#3e424a';
                var newInnerKnobBack = 'linear-gradient(145deg, #42474f, #383b43)';
                var newInnerKnobShadow = '8px -8px 16px #191a1e,-8px 8px 16px #636a76';
                var newGeneralColor = 'white';
                var newBlackKeys = '#3e424a';
                var newSoundListButton = "-7px 7px 14px #2b2e34,7px -7px 14px #515660";
                var newParameterKnobShadow = "-5px 5px 10px #33363d,5px -5px 10px #494e57";
                var newParameterHeaderShadow = "8px -8px 16px #1b1f20,-8px 8px 16px #41494c";
                var newSliderThumbShadow = "7px 7px 19px #1a1c1f, -7px -7px 19px #626875";
                var newQueryButtonShadow = "8px -8px 16px #1b1f20,-8px 8px 16px #41494c";
                var newWaveformShadow = "inset 6px -6px 12px #272c2e,inset -6px 6px 12px #353c3e";
                var newLaunchModeShadow = "-5px -5px 10px #222429,5px 5px 200px #5a606b";
                var newBrShadow = "-6px 6px 15px rgba(95, 185, 185, 1)";
                var newtlShadow = "6px -6px 15px rgba(95, 185, 185)";
                var newParameterKnobBackground = "linear-gradient(225deg, #42474f, #383b43)";
                var newLaunchOuterBoxShadow = "-5px -5px 10px #222429,5px 5px 10px #5a606b";
                var newAdsrHeaderShadow = "-5px -5px 10px #222429,5px 5px 200px #5a606b";
                var newQueryTextShadow = "inset 5px 5px 3px #35383f,inset -5px -5px 3px #474c55";
                var newSliderTrackShadow = "5px 5px 10px #1f2125, -5px -5px 15px #5d636f";
                var newIconShadow = "none";
                var newIconBackground = "#838486";
                var newWhiteKeyShadow = "-1px 1px 5px #b7b7b6, 1px -1px 5px #fff";
                var newAdsrShadow = "inset 6px -6px 12px #272c2e,inset -6px 6px 12px #353c3e";
                newInnerBoxBorder = "#5fb9b9a1";
                var newQueryIcon = "#5fb9b9a1";
                var newBlackHover = "black";
                var newKnobProgressColor = "cyan";


                //Change the waveform color
                wavesurferColor = '#5fb9b9a1';

                //Change the background of ADSR Envelope
                adsrBackgroundColor = '#3e424a';


                //Change the progress color of knobs
                $(".knob-1,.knob-100,.knob-12,.knob-2000,.knob-reverb").trigger('configure',
                    {
                        'fgColor': newKnobProgressColor,
                    }
                );
                if (wavesurfer) {
                    wavesurfer.setWaveColor('#5fb9b9a1');
                }

                if (selectedSoundUUID) {
                    drawAdsrEnvelope();
                }

            } else {
                var newVal = "0";
                var newBackground = '#f2f1f1';
                var newInnerKnobBack = 'linear-gradient(45deg, #dad9d9, #ffffff)';
                var newInnerKnobShadow = '5px -5px 6px #e3e3e3,-5px 5px 6px #ffffff';
                var newGeneralColor = 'purple';
                var newBlackKeys = '#711771d1';
                var newSoundListButton = "5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff";
                var newParameterKnobShadow = "-5px 5px 10px #eaeaea, 5px -5px 10px #ffffff";
                var newParameterHeaderShadow = "5px -5px 2px #ececec, -5px 5px 17px #fff";
                var newQueryButtonShadow = "3px -3px 6px #d3d2d2,-3px 3px 6px #ffffff";
                var newWaveformShadow = "-5px -5px 0px #d4d2d2,5px 5px 100px #ffffff";
                var newLaunchModeShadow = "5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff";
                var newBrShadow = "-6px 6px 15px rgb(80, 1, 80)";
                var newtlShadow = "6px -6px 15px rgb(238, 197, 182)";
                var newParameterKnobBackground = "#f2f1f1";
                var newLaunchOuterBoxShadow = "5px -5px 10px #c6c0c0, -5px 5px 40px #fffdfd";
                var newAdsrHeaderShadow = "rgb(211, 210, 210)0px -5px 10px, rgb(255, 255, 255) -5px 5px 10px";
                var newQueryTextShadow = "inset 5px -5px 10px #dcdbdb,inset -5px 5px 10px #ffffff";
                var newSliderTrackShadow = " -5px 5px 10px #32353b,5px -5px 10px #4a4f59";
                var newSliderThumbShadow = "-5px 5px 10px #c2c1c1,5px -5px 10px #ffffff";
                var newWhiteKeyShadow = " -5px 5px 10px #e7e7e7,5px -5px 10px #ffffff";
                var newAdsrShadow = "rgb(204, 219, 232) 3px 3px 6px 0px inset, rgba(255, 255, 255, 0.5) -3px -3px 6px 1px inset";
                var newIconBackground = "purple";
                var newIconShadow = " 5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff";
                newInnerBoxBorder = "#80008033";
                var newQueryIcon = "rgba(118, 20, 148, 0.7)";
                var newBlackHover = "purple";
                var newKnobProgressColor = "purple";

                wavesurferColor = 'purple;'
                adsrBackgroundColor = '#f2f1f1';

                if (wavesurfer) {
                    wavesurfer.setWaveColor('purple');
                }

                $(".knob-1,.knob-100,.knob-12,.knob-2000,.knob-reverb").trigger('configure',
                    {
                        'fgColor': newKnobProgressColor,
                    }
                );

                if (selectedSoundUUID) {
                    drawAdsrEnvelope();
                }


            }
            document.documentElement.style.setProperty('--background-color', newBackground);
            document.documentElement.style.setProperty('--knob-inner-back', newInnerKnobBack);
            document.documentElement.style.setProperty('--knob-inner-shadow', newInnerKnobShadow);
            document.documentElement.style.setProperty('--general-color', newGeneralColor);
            document.documentElement.style.setProperty('--black-keys', newBlackKeys);
            document.documentElement.style.setProperty('--sound-list-button', newSoundListButton);
            document.documentElement.style.setProperty('--parameter-knobs-shadow', newParameterKnobShadow);
            document.documentElement.style.setProperty('--parameter-header-shadow', newParameterHeaderShadow);
            document.documentElement.style.setProperty('--query-button-shadow', newQueryButtonShadow);
            document.documentElement.style.setProperty('--waveform-soundlist-shadow', newWaveformShadow);
            document.documentElement.style.setProperty('--launch-mode-shadow', newLaunchModeShadow);
            document.documentElement.style.setProperty('--brShadow', newBrShadow);
            document.documentElement.style.setProperty('--tlShadow', newtlShadow);
            document.documentElement.style.setProperty('--parameter-knob-background', newParameterKnobBackground);
            document.documentElement.style.setProperty('--outer-box-shadow', newLaunchOuterBoxShadow);
            document.documentElement.style.setProperty('--adsr-header-shadow', newAdsrHeaderShadow);
            document.documentElement.style.setProperty('--query-text-shadow', newQueryTextShadow);
            document.documentElement.style.setProperty('--slider-track-shadow', newSliderTrackShadow);
            document.documentElement.style.setProperty('--slider-thumb-shadow', newSliderThumbShadow);
            document.documentElement.style.setProperty('--icon-background', newIconBackground);
            document.documentElement.style.setProperty('--icon-shadow', newIconShadow);
            document.documentElement.style.setProperty('--white-key-shadow', newWhiteKeyShadow);
            document.documentElement.style.setProperty('--adsr-shadow', newAdsrShadow);
            document.documentElement.style.setProperty('--inner-box-border', newInnerBoxBorder);
            document.documentElement.style.setProperty('--query-icon', newQueryIcon);
            document.documentElement.style.setProperty('--black-key-hover', newBlackHover);
            document.documentElement.style.setProperty('--knob-progress-color', newKnobProgressColor);
            $('.mode-button').attr('value', newVal);


        }

        function updateReverseState() {
            var val = $('#reverse').attr('value');
            if (val === 1) {
                $('#reverse').attr('value', 0);
                ss.setSoundParameterInt('reverse', val);
                ss.playSound();
                return null;
            } else {
                $('#reverse').attr('value', 1);
                ss.setSoundParameterInt('reverse', val);
                ss.playSound();
                return null;
            }



        }
        function saveCurrentUserActionTime() {
            lastUIAction = (new Date()).getTime();
        }

        function msSinceLastUserAction() {
            return (new Date()).getTime() - lastUIAction;
        }

        function linToExp(x) {
            return (Math.pow(x, expStrength));
        }

        function expToLin(x) {
            return (Math.pow(x, 1 / expStrength));
        }

        function sliderShouldBehaveExponentially(sliderElement) {
            var name = sliderElement.name;
            if (name != null) {
                if ((name.toLowerCase().indexOf("attack") > -1) ||
                    (name.toLowerCase().indexOf("decay") > -1) ||
                    (name.toLowerCase().indexOf("release") > -1) ||
                    (name == "filterCutoff")
                ) {
                    return true;
                }
            }

            return false;
        }

        function getProcessedSoundParameterValuLinToExp(parameterName, parameterVal, parameterMin, parameterMax) {
            var value = parseFloat(parameterVal, 10);
            return value;
        }

        function getProcessedSoundParameterValueExpToLin(sliderElement, valueRaw) {
            if (sliderShouldBehaveExponentially(sliderElement) == true) {
                return expToLin(valueRaw / sliderElement.max) * sliderElement.max;
            } else {
                return valueRaw;
            }
        }

        function getMidiControllableParameterNames() {
            // --> Start auto-generated code B
            parameterNames = ["startPosition", "endPosition", "loopStartPosition", "loopEndPosition", "playheadPosition", "freezePlayheadSpeed", "filterCutoff", "filterRessonance", "gain", "pan", "pitch"]
            // --> End auto-generated code B
            return parameterNames;
        }

        function getAllSoundParameterNames() {
            // --> Start auto-generated code C
            parameterNames = ["launchMode", "startPosition", "endPosition", "loopStartPosition", "loopEndPosition", "loopXFadeNSamples", "reverse", "noteMappingMode", "numSlices", "playheadPosition", "freezePlayheadSpeed", "filterCutoff", "filterRessonance", "filterKeyboardTracking", "filterAttack", "filterDecay", "filterSustain", "filterRelease", "filterADSR2CutoffAmt", "gain", "attack", "decay", "sustain", "release", "pan", "pitch", "pitchBendRangeUp", "pitchBendRangeDown", "mod2CutoffAmt", "mod2GainAmt", "mod2PitchAmt", "mod2PlayheadPos", "vel2CutoffAmt", "vel2GainAmt", "midiChannel"]
            // --> End auto-generated code C
            return parameterNames;
        }

        function isSoundParameter(parameterName) {
            return getAllSoundParameterNames().indexOf(parameterName) > -1;
        }

        function getAllSoundParameterTypes() {
            // --> Start auto-generated code D
            parameterTypes = ["int", "float", "float", "float", "float", "int", "int", "int", "int", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "int"]
            // --> End auto-generated code D
            return parameterTypes;
        }

        function getParameterType(parameterName) {
            return getAllSoundParameterTypes()[getAllSoundParameterNames().indexOf(parameterName)];
        }

        // Methods to update different parts of the UI


        function addNewMIDIMappingEditor(soundUUID) {
            document.getElementById('newMappingPlaceholder_' + soundUUID).innerHTML = createMIDIMappingEditorFromRawParams(soundUUID, "", 0, "", 0.0, 1.0);
        }

        function createMIDIMappingEditor(soundUUID, mapping) { // mapping xml form state
            var mappingUUID = mapping.getAttribute('uuid');
            var ccNumber = parseInt(mapping.getAttribute('ccNumber'), 10);
            var name = mapping.getAttribute('parameterName');
            var minRange = parseFloat(mapping.getAttribute('minRange'), 10);
            var maxRange = parseFloat(mapping.getAttribute('maxRange'), 10);
            return createMIDIMappingEditorFromRawParams(soundUUID, mappingUUID, ccNumber, name, minRange, maxRange);
        }

        function createMIDIMappingEditorFromRawParams(soundUUID, mappingUUID, ccNumber, parameterName, minRange, maxRange) {
            html = '<div id="' + mappingUUID + '" data-sound-id="' + soundUUID + '" class="midiMapping">';
            html += 'CC number: <input id="' + mappingUUID + '_mappingCCNumber" value="' + ccNumber + '" type="number"><br>';
            html += 'Parameter: <select class="select-css" id="' + mappingUUID + '_mappingParameterName">';
            var availableParams = getMidiControllableParameterNames();
            for (var i = 0; i < availableParams.length; i++) {
                if (availableParams[i] != parameterName) {
                    html += '<option value="' + availableParams[i] + '">&nbsp;&nbsp;' + availableParams[i] + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>';
                } else {
                    html += '<option value="' + availableParams[i] + '" selected>&nbsp;&nbsp;' + availableParams[i] + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>';
                }
            }
            html += '</select><br>';
            html += '<input type="range" id="' + mappingUUID + '_mappingMinRange"  min="0" max="1.0" value="' + minRange + '" step="0.01"> min: <span id="' + mappingUUID + '_mappingMinRangeLabel"></span><br>';
            html += '<input type="range" id="' + mappingUUID + '_mappingMaxRange"  min="0" max="1.0" value="' + maxRange + '" step="0.01"> max: <span id="' + mappingUUID + '_mappingMaxRangeLabel"></span><br>';
            html += '<button onclick="ss.createUpdateMapping(\'' + soundUUID + '\',\'' + mappingUUID + '\')">save</button><button onclick="ss.removeMidiMapping(\'' + soundUUID + '\',\'' + mappingUUID + '\')">x</button>';
            html += '</div>';
            return html;
        }
        function updateSoundParameter(soundUUID, parameterName, parameterValue) {
            const sliderElement = document.getElementById(soundUUID + '_' + parameterName);
            if (sliderElement === null) {
                return;
            }
            if (parameterValue === undefined) {
                var sound = ss.getSoundFromSoundUUID(soundUUID);
                parameterValue = sound.getAttribute(parameterName);
            }
            const parameterType = getParameterType(parameterName);
            if (parameterType == "float") {
                sliderElement.value = getProcessedSoundParameterValueExpToLin(sliderElement, parseFloat(parameterValue, 10));
            } else if (parameterType == "int") {
                sliderElement.value = parseInt(parameterValue, 10);
            }
            updateSliderLabel(sliderElement);
        }

        function updateMIDIMappingEditor(mappingUUID) {
            var mapping = ss.getMidiMappingStateFromMappingUUID(mappingUUID);
            var ccNumber = parseInt(mapping.getAttribute('ccNumber'), 10);
            var name = mapping.getAttribute('parameterName');
            var minRange = parseFloat(mapping.getAttribute('minRange'), 10);
            var maxRange = parseFloat(mapping.getAttribute('maxRange'), 10);

            document.getElementById(mappingUUID + '_mappingCCNumber').value = ccNumber;
            document.getElementById(mappingUUID + '_mappingParameterName').value = name;
            document.getElementById(mappingUUID + '_mappingMinRange').value = minRange;
            document.getElementById(mappingUUID + '_mappingMinRangeLabel').innerHTML = minRange;
            document.getElementById(mappingUUID + '_mappingMaxRange').value = maxRange;
            document.getElementById(mappingUUID + '_mappingMaxRangeLabel').innerHTML = maxRange;
        }


        function changeADSRElementId(obj) {
            var currentMode = $('#outer-box-adsr #inner-box-launch p').text();
            var currentModeIndex = adsrModes.indexOf(currentMode.toLowerCase());
            var nextModeIndex = currentModeIndex;

            //Get the direction of arrow
            var direction = obj.className;
            var nextModeIndex = leftRightUpdate(direction, currentModeIndex, 2);
            var progressColor = getComputedStyle(document.documentElement).getPropertyValue('--knob-progress-color');

            if (nextModeIndex === 0) {
                $('#attack').attr("id", "filterAttack");
                $('#decay').attr("id", "filterDecay");
                $('#sustain').attr("id", "filterSustain");
                $('#release').attr("id", "filterRelease");
                $('#gain').attr("id", "filterCutoff");
                $('#filterCutoff>p').text("cutoff");
                $('#filterCutoff').trigger('configure', {
                    'min': 10,
                    'max': 20000,
                });
                $('.adsr-second-knob').empty();
                $('.adsr-second-knob').append(`
                        <div class="knob-2000" id="filterCutoff">
                            <div class="knob-inner"></div>
                            <p style="margin-left:7.5px;">cutoff</p>
                        </div>
                        <div class="knob-1" id="filterRessonance">
                            <div class="knob-inner"></div>
                            <p style="margin-left:9px;">ressonance</p>
                        </div>
                            <div class="knob-100" id="filterADSR2CutoffAmt">
                                <div class="knob-inner"></div>
                                <p style="margin-left:8px;">cutoff amount</p>
                            </div>
                       `);

                $("#filterCutoff").knob({
                    'min': 10,
                    'max': 20000,
                    'step': 1,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1)
                    }
                });
                $("#filterRessonance").knob({
                    'min': 0,
                    'max': 1,
                    'step': 0.01,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'font': 'var(--font-default)',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                        if (adsrList.includes(this['$'][0]['id'])) {
                            drawAdsrEnvelope();
                        }
                    }
                });
                $("#filterADSR2CutoffAmt").knob({
                    'min': 0,
                    'max': 100,
                    'step': 0.01,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                    }
                });

                updateFilterADSR();
            } else {
                $('#filterAttack').attr("id", "attack");
                $('#filterDecay').attr("id", "decay");
                $('#filterSustain').attr("id", "sustain");
                $('#filterRelease').attr("id", "release");
                $('.adsr-second-knob').empty();
                $('.adsr-second-knob').append(`
                        <div class="knob-2000" id="gain">
                            <div class="knob-inner"></div>
                            <p style="margin-left:7.5px;">gain</p>
                        </div>
                        <div class="knob-1" id="pan">
                            <div class="knob-inner"></div>
                            <p style="margin-left:9px;">pan</p>
                        </div>
                       `);
                $("#gain").knob({
                    'min': -80,
                    'max': 12,
                    'step': 1,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1)
                    }
                });
                $("#pan").knob({
                    'min': -1,
                    'max': 1,
                    'step': 0.01,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'font': 'var(--font-default)',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                        if (adsrList.includes(this['$'][0]['id'])) {
                            drawAdsrEnvelope();
                        }
                    }
                });
            }
            var newAdsrText = adsrModes[nextModeIndex];
            $('#outer-box-adsr #inner-box-launch p').text(newAdsrText);

            //Only update for ADSR elements should be added
            updateAmplitudeADSR();
        }

        function changeModulationVelocityID(obj) {
            var currentMode = $('#outer-box-modulation-velocity #inner-box-launch p').text();
            var currentModeIndex = modVelocityModes.indexOf(currentMode.toLowerCase());
            var nextModeIndex = currentModeIndex;

            //Get the direction of arrow
            var direction = obj.className;
            var nextModeIndex = leftRightUpdate(direction, currentModeIndex, 2);

            var newText = modVelocityModes[nextModeIndex];
            $('#outer-box-modulation-velocity #inner-box-launch p').text(newText);

            var progressColor = getComputedStyle(document.documentElement).getPropertyValue('--knob-progress-color');

            if (nextModeIndex === 1) {
                $('.modulation-velocity-knob-area').empty();
                $('.modulation-velocity-knob-area').append(`<div class="knob-100" id="vel2CutoffAmt">
                                                                    <div class="knob-inner"></div>
                                                                    <p style="margin-left:7px;">cutoff</p>
                                                                    </div>
                                                                    <div class="knob-1" id="vel2GainAmt">
                                                                        <div class="knob-inner"></div>
                                                                    <p style="margin-left:7px;">gain</p>
                                                                    </div>`);
                $('#vel2CutoffAmt').knob({
                    'min': 0,
                    'max': 100,
                    'step': 0.01,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                    }
                });
                $('#vel2GainAmt').knob({
                    'min': 0,
                    'max': 1,
                    'step': 0.01,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'font': 'var(--font-default)',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                        if (adsrList.includes(this['$'][0]['id'])) {
                            drawAdsrEnvelope();
                        }
                    }
                });
            }
            else {
                $('.modulation-velocity-knob-area').empty();
                $('.modulation-velocity-knob-area').append(`
                                                                    <div class="knob-12" id="mod2GainAmt">
                                                                        <div class="knob-inner"></div>
                                                                        <p style="margin-left:7.5px;">gain</p>
                                                                    </div>
                                                                    <div class="knob-100" id="mod2CutoffAmt">
                                                                        <div class="knob-inner"></div>
                                                                        <p style="margin-left:7.5px;">cutoff</p>
                                                                    </div>
                                                                    <div class="knob-12" id="mod2PitchAmt">
                                                                        <div class="knob-inner"></div>
                                                                        <p style="margin-left:7px;">pitch</p>
                                                                    </div>
                                                               `);
                $('#mod2GainAmt').knob({
                    'min': -12,
                    'max': 12,
                    'step': 0.01,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                    }
                });
                $('#mod2PitchAmt').knob({
                    'min': -12,
                    'max': 12,
                    'step': 0.01,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                    }
                });
                $('#mod2CutoffAmt').knob({
                    'min': 0,
                    'max': 100,
                    'step': 0.01,
                    'width': 45,
                    'height': 45,
                    'displayInput': true,
                    'thickness': 0.2,
                    'angleOffset': 180,
                    'fgColor': progressColor,
                    'bgColor': '#dad9d9',
                    'change': function (v) {
                        ss.setSoundParameter(this['$'][0]['id'], v, 0, 1);
                    }
                });
            }
        }

        function changeNoteLayout() {
            if ($('#noteLayout p').text() === 'contiguous') {
                var newNoteLayout = 'interleaved';
                var noteLayoutVal = 1;
            } else {
                var newNoteLayout = 'contiguous';
                var noteLayoutVal = 0;
            }
            $('#noteLayout p').text(newNoteLayout);
            ss.reapplyLayout(noteLayoutVal);
        }


        function updateMainPresetParameters() {
            var sourceState = ss.state.getElementsByTagName('SOURCE_STATE')[0];
            document.getElementsByName('presetIdx')[0].value = sourceState.getAttribute('currentPresetIndex');
            document.getElementsByName('midiInChannel')[0].value = sourceState.getAttribute('globalMidiInChannel');

            var presetState = sourceState.getElementsByTagName('PRESET')[0];
            document.getElementsByName('presetName')[0].value = presetState.getAttribute('name');
            document.getElementsByName('numVoices')[0].value = presetState.getAttribute('numVoices');

        }


        function leftRightUpdate(direction, currentModeIndex, n) {
            var nextModeIndex = null;
            if (direction == 'left-arrow-inner') {
                nextModeIndex = currentModeIndex - 1;
                if (nextModeIndex < 0) {
                    nextModeIndex = 1;
                }

            } else {
                nextModeIndex = currentModeIndex + 1;
                if (nextModeIndex == n) {
                    nextModeIndex = 0;
                }
            }
            return nextModeIndex;
        }

        function updateLaunchMode(obj) {
            var currentMode = $("#outer-box-launch > #inner-box-launch > p").text();
            var currentModeIndex = launchModes.indexOf(currentMode.toLowerCase());
            var nextModeIndex = currentModeIndex;

            //If it's not sound change but launch mode change
            //Get the next launch mode
            if (obj !== undefined) {
                //Get the direction of arrow
                var direction = obj.className;
                var nextModeIndex = leftRightUpdate(direction, currentModeIndex, 3);
                var newText = launchModes[nextModeIndex];
                ss.setSoundParameterInt('launchMode', nextModeIndex);
                $("#outer-box-launch > #inner-box-launch > p").text(newText);

                var startP = ss.getSoundParameterValue(selectedSoundUUID, 'startPosition');
                var endP = ss.getSoundParameterValue(selectedSoundUUID, 'endPosition');

                //Load looper area if the launch mode is loop or loopfb
                if (nextModeIndex > 0) {
                    //If launch mode changes, stop all sounds
                    for (midiRoot of loopTriggerMidiOnOffSet.values()) {
                        ss.sendMidiNoteOff(midiRoot);
                    }
                    //Clear the set
                    loopTriggerMidiOnOffSet.clear();

                    wavesurfer.regions.clear();
                    //Get the duration to create fitting region
                    var soundLength = ss.getSoundDuration(selectedSoundUUID);
                    var regionStart = 0;
                    var regionEnd = soundLength / 4;

                    if (startP !== 0 & endP !== 1) {
                        var regionStart = startP * soundLength;
                        var regionEnd = endP * soundLength;
                    }
                    wavesurfer.addRegion({
                        start: regionStart,
                        end: regionEnd,
                        loop: false,
                        color: 'hsla(240, 3%, 94%, 0.5)'
                    })
                    wavesurfer.on('region-updated', region => {


                        //Set the start and end of the looped sound
                        ss.setSoundParameter('startPosition', region.start / soundLength, 0, 1);
                        ss.setSoundParameter('endPosition', region.end / soundLength, 0, 1);
                        ss.setSoundParameter('loopStartPosition', region.start / soundLength, 0, 1);
                        ss.setSoundParameter('loopEndPosition', region.end / soundLength, 0, 1);

                    })
                } else {
                    wavesurfer.regions.clear();
                    $('select#sound-dropdown option').each(function (index, element) {
                        var soundListUUID = $(element).data('uuid');
                        ss.setSoundParameter('startPosition', 0, 0, 1, resetMode = soundListUUID);
                        ss.setSoundParameter('endPosition', 1, 0, 1, resetMode = soundListUUID);
                        ss.setSoundParameter('loopStartPosition', 0, 0, 1, resetMode = soundListUUID);
                        ss.setSoundParameter('loopEndPosition', 1, 0, 1, resetMode = soundListUUID);

                    });
                }
                //If its sound change
            } else {
                ss.setSoundParameterInt('launchMode', nextModeIndex);
                wavesurfer.regions.clear();
                var startP = ss.getSoundParameterValue(selectedSoundUUID, 'startPosition');
                var endP = ss.getSoundParameterValue(selectedSoundUUID, 'endPosition');

                //Load looper area if the launch mode is loop or loopfb
                if (nextModeIndex > 0) {
                    //Get the duration to create fitting region
                    var soundLength = ss.getSoundDuration(selectedSoundUUID);
                    var regionStart = 0;
                    var regionEnd = soundLength / 4;

                    if (startP !== 0 & endP !== 1) {
                        var regionStart = startP * soundLength;
                        var regionEnd = endP * soundLength;
                        console.log('new start and end ', endP, startP, regionStart, regionEnd);
                    }
                    wavesurfer.addRegion({
                        start: regionStart,
                        end: regionEnd,
                        loop: false,
                        color: 'hsla(400, 100%, 30%, 0.5)'
                    })
                    console.log(ss.getSoundParameterValue(selectedSoundUUID, 'startPosition'),
                        ss.getSoundParameterValue(selectedSoundUUID, 'endPosition'),
                        ss.getSoundParameterValue(selectedSoundUUID, 'loopStartPosition'),
                        ss.getSoundParameterValue(selectedSoundUUID, 'loopEndPosition'));
                    wavesurfer.on('region-updated', region => {

                        //Set the start and end of the looped sound
                        ss.setSoundParameter('startPosition', region.start / soundLength, 0, 1);
                        ss.setSoundParameter('endPosition', region.end / soundLength, 0, 1);
                        ss.setSoundParameter('loopStartPosition', region.start / soundLength, 0, 1);
                        ss.setSoundParameter('loopEndPosition', region.end / soundLength, 0, 1);

                    })
                }

            }
        }

        function updateGateTriggerMode(obj) {
            var currentMode = $("#outer-box-keyboard > #inner-box-launch > p").text();
            var currentModeIndex = gateTriggerModes.indexOf(currentMode.toLowerCase());
            var nextModeIndex = currentModeIndex;

            //Get the direction of arrow
            var direction = obj.className;
            if (direction == 'left-arrow-inner') {
                nextModeIndex = currentModeIndex - 1;
                if (nextModeIndex < 0) {
                    nextModeIndex = 1;
                }

            } else {
                nextModeIndex = currentModeIndex + 1;
                if (nextModeIndex == 2) {
                    nextModeIndex = 0;
                }
            }
            var newText = gateTriggerModes[nextModeIndex];

            //Stop sounds from previous mode
            for (midiRoot of loopTriggerMidiOnOffSet.values()) {
                ss.sendMidiNoteOff(midiRoot);
                $('#' + midiRoot).removeClass('flash');
            }
            for (midiRoot of midiOnOffList.values()) {
                ss.sendMidiNoteOff(midiRoot);
            }
            $("#outer-box-keyboard > #inner-box-launch > p").text(newText);
        }

        function removeSoundFromList() {

            //Stop the sound first
            ss.stopSound(selectedSoundUUID);

            var sound = ss.getSoundFromSoundUUID(selectedSoundUUID);
            var samplerSounds = ss.getSoundSamplerSounds(sound);
            var samplerSound = samplerSounds[0];
            //Remove the sound from sound list
            $("select#sound-dropdown option").filter(":contains('" + samplerSound.getAttribute('name') + "')").remove();

            //Remove the sound from state
            ss.removeSound(selectedSoundUUID);


        }
        function updateSoundList(soundUUID) {
            var sound = ss.getSoundFromSoundUUID(soundUUID);
            console.log('updating sound list', soundUUID);

            if (sound === null) {
                // Sound can be null if triggering this method in a delayed way and sound does not longer exist
                return;
            }
            //Wait until the query is done
            var samplerSounds = ss.getSoundSamplerSounds(sound);
            var samplerSound = samplerSounds[0];
            //If sound exists and loaded, don't add id
            $("div.sound-list select").append($('<option>')
                .text(samplerSound.getAttribute('name'))
                .data({
                    uuid: soundUUID,
                    sound: samplerSound.getAttribute('name'),
                })
            );
        }


        function updateVolatileUI() {
            // Update the audio meters and the voice allocation section
            // Also update other things like query status


            //Launch Mode Check
            checkBox = document.getElementById('loopfb');

            var VolatileState = ss.volatileState.getElementsByTagName('VOLATILE_STATE')[0];

            var isQuerying = VolatileState.getAttribute('isQuerying') != "0";
            var queryingIndicator = document.getElementById('query-indicator');
            if (isQuerying) {
                queryingIndicator.classList.add('query-animation');

            } else {
                queryingIndicator.classList.remove('query-animation');
            }

        }

        function drawSoundWaveform() {
            var sound = ss.getSoundFromSoundUUID(selectedSoundUUID);
            var samplerSound = ss.getSoundSamplerSounds(sound);
            var sourceSamplerSoundUUID = samplerSound[0].getAttribute('uuid');

            const canvas = document.getElementById("waveform");
            if (canvas !== null) {
                if (httpPort !== undefined) {
                    let url = 'http' + (useHttps ? 's' : '') + '://' + hostname + ':' + httpPort + '/sounds_data/' + sourceSamplerSoundUUID + '.wav';
                    //let url = ss.getTmpFilesLocation() + '/' + sourceSamplerSoundUUID + '.wav'; // Not supported because of CORS...

                    //Remove the previous sounds wave element
                    $('wave').remove();
                    wavesurfer = WaveSurfer.create({
                        container: document.querySelector('#waveform'),
                        waveColor: wavesurferColor,
                        progressColor: 'transparent',
                        backend: 'MediaElement',
                        cursorWidth: 0,
                        responsive: 'true',
                        height: '100',
                        plugins: [WaveSurfer.regions.create({}),
                        WaveSurfer.cursor.create({
                            showTime: true,
                            opacity: 1,
                            customShowTimeStyle: {
                                'background-color': '#000',
                                color: '#fff',
                                padding: '2px',
                                'font-size': '10px'
                            }
                        })

                        ]

                    });
                    wavesurfer.load(url);
                }
            }
        }



        function drawAdsrEnvelope() {

            var DefaultParamsMod = {
                attackTime: ss.getSoundParameterValue(selectedSoundUUID, 'filterAttack'),
                decayTime: ss.getSoundParameterValue(selectedSoundUUID, 'filterDecay'),
                sustainLevel: ss.getSoundParameterValue(selectedSoundUUID, 'filterSustain'),
                releaseTime: ss.getSoundParameterValue(selectedSoundUUID, 'filterRelease'),
                gateTime: 1,
                peakLevel: 1,
                epsilon: 0.001,
                attackCurve: "exp",
                decayCurve: "exp",
                releaseCurve: "exp",
            };

            var DefaultParamsAmp = {
                attackTime: ss.getSoundParameterValue(selectedSoundUUID, 'attack'),
                decayTime: ss.getSoundParameterValue(selectedSoundUUID, 'decay'),
                sustainLevel: ss.getSoundParameterValue(selectedSoundUUID, 'sustain'),
                releaseTime: ss.getSoundParameterValue(selectedSoundUUID, 'release'),
                gateTime: 1,
                peakLevel: 1,
                epsilon: 0.001,
                attackCurve: "exp",
                decayCurve: "exp",
                releaseCurve: "exp",
            };

            //If the page has just loaded, operate on default parameter values
            startTime = -1;

            var env = new ADSREnvelope(DefaultParamsMod);
            var ampEnv = new ADSREnvelope(DefaultParamsAmp);


            var canvas = document.getElementById("adsr-envelope");
            var context = canvas.getContext("2d");

            var contextAmp = canvas.getContext("2d");
            var x, i;

            duration = (((env.duration / 5) | 0) + 1) * 5;

            context.fillStyle = adsrBackgroundColor;
            context.fillRect(0, 0, canvas.width, canvas.height);

            //Filter ADSR
            context.strokeStyle = "#000000";
            context.lineWidth = 0.8;

            for (i = 1; i < duration; i++) {
                x = (((i / duration) * canvas.width) | 0) + 0.5;

                context.beginPath();
                context.moveTo(x, 0);
                context.lineTo(x, canvas.height);
                context.stroke();
            }

            //Amplitude ADSR
            contextAmp.strokeStyle = newInnerBoxBorder;
            contextAmp.lineWidth = 0.8;

            for (i = 1; i < duration; i++) {
                x = (((i / duration) * canvas.width) | 0) + 0.5;

                contextAmp.beginPath();
                contextAmp.moveTo(x, 0);
                contextAmp.lineTo(x, canvas.height);
                contextAmp.stroke();
            }

            //Draw two envelopes for modulation and amplitude
            drawByEnvelope(contextAmp, duration, ampEnv, 1.4, "#5fb9b9a1", 'amp');
            drawByEnvelope(context, duration, env, 1.4, "rgba(118, 20, 148, 1)", 'modulation');


            function drawByEnvelope(context, duration, env, lineWidth, strokeStyle, type) {
                var t, v, y, x;
                var i, imax;
                var canvas = document.getElementById("adsr-envelope");


                context.strokeStyle = strokeStyle;
                context.lineWidth = lineWidth;
                context.lineCap = "round";

                context.beginPath();
                for (i = 0, imax = canvas.width; i < imax; i++) {
                    t = (i / imax) * duration;
                    v = env.valueAt(t);
                    y = canvas.height - (canvas.height * v);
                    x = (i / imax) * canvas.width;

                    context.lineTo(x, y);
                }
                context.stroke();

            }
        }
    </script>
</head>

<body>
    <div class="container">
        <div class="source-icon">
            SOURCE
            <div class="mode-button" onclick="switchColorModes(this);" value="0">
                <p>mode</p>
            </div>
        </div>
        <div class="query-parameters">
            <div class="query-search">
                <div class="query-text">
                    <input class="query-box" name="query" type="text" />
                </div>
                <div class="query-button" onclick="ss.addSoundsByQuery()">
                    <div class="query-icon">
                        <svg fill="none" height="18" id="query-indicator" stroke="#d4d2d2" stroke-linecap="round"
                            stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="18"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" x2="16.65" y1="21" y2="16.65"></line>
                        </svg>
                    </div>
                </div>
            </div>
            <div id="q-par-labels">
                <p style="margin-left: 5px;">Number of sounds</p>
                <p style="margin-left: -5px;">Min/Max Sound Length</p>
                <p style="margin-left: 2px;">Note Layout Type</p>
            </div>
            <div id="q-par">
                <div class="single-slider">
                </div>
                <div class="double-slider">
                </div>
                <div class="slider-regular" id="noteLayout" onclick="changeNoteLayout();">
                    <p style="margin-top:3px;">contiguous</p>
                </div>
            </div>
        </div>
        <div class="waveform">
            <div id="waveform"></div>
            <div class="launch-mode">
                <div class="left-arrow">
                    <button class="left-arrow-inner" onclick="updateLaunchMode(this);"></button>
                </div>
                <div class="outer-box" id="outer-box-launch">
                    <div class="inner-box" id="inner-box-launch">
                        <p>default</p>
                    </div>
                </div>
                <div class="right-arrow">
                    <button class="right-arrow-inner" onclick="updateLaunchMode(this);"></button>
                </div>
            </div>
        </div>
        <div class="adsr">
            <canvas id="adsr-envelope" style="background-color: transparent;"></canvas>
        </div>
        <div class="adsr-envelope-knobs">
            <div class="adsr-header">
                <div class="left-arrow">
                    <button class="left-arrow-inner" onclick="changeADSRElementId(this);"></button>
                </div>
                <div class="outer-box" id="outer-box-adsr">
                    <div class="inner-box" id="inner-box-launch">
                        <p>amplitude</p>
                    </div>
                </div>
                <div class="right-arrow">
                    <button class="right-arrow-inner" onclick="changeADSRElementId(this);"></button>
                </div>
            </div>
            <div class="adsr-first-knob">
                <div class="knob-1" id="attack">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">attack</p>
                </div>
                <div class="knob-1" id="decay">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">decay</p>
                </div>
                <div class="knob-1" id="sustain">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7px;">sustain</p>
                </div>
                <div class="knob-1" id="release">
                    <div class="knob-inner"></div>
                    <p style="margin-left:8px;">release</p>
                </div>
            </div>
            <div class="adsr-second-knob">
                <div class="knob-2000" id="gain">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">gain</p>
                </div>
                <div class="knob-1" id="pan">
                    <div class="knob-inner"></div>
                    <p style="margin-left:9px;">pan</p>
                </div>
            </div>
        </div>
        <div class="sound-list">
            <select id="sound-dropdown" multiple="" name="sounds" onchange="updateGlobalSoundUUID();"
                style="width:100%;height:100%;">
            </select>
            <div class="sound-list-options">
                <div class="sound-list-buttons">
                    <div class="stop-icon" onclick="ss.stopSound('stop');"></div>
                </div>
                <div class="sound-list-buttons">
                    <div class="remove-icon" onclick="removeSoundFromList();"></div>
                </div>
                <div class="sound-list-buttons" id="reverse" onclick="ss.playSound();" value="0">
                </div>
            </div>
        </div>
        <div class="parameter-knobs">
            <div class="modulation-velocity-header">
                <div class="left-arrow">
                    <button class="left-arrow-inner" onclick="changeModulationVelocityID(this);"></button>
                </div>
                <div class="outer-box" id="outer-box-modulation-velocity">
                    <div class="inner-box" id="inner-box-launch">
                        <p>modulation</p>
                    </div>
                </div>
                <div class="right-arrow">
                    <button class="right-arrow-inner" onclick="changeModulationVelocityID(this);"></button>
                </div>
            </div>
            <div class="modulation-velocity-knob-area">
                <div class="knob-12" id="mod2GainAmt">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">gain</p>
                </div>
                <div class="knob-100" id="mod2CutoffAmt">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">cutoff</p>
                </div>
                <div class="knob-12" id="mod2PitchAmt">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7px;">pitch</p>
                </div>
            </div>
            <div class="reverb-knob-area">
                <div class="knob-reverb" id="roomSize">
                    <div class="knob-inner"></div>
                    <p style="margin-left:6.5px;">room</p>
                </div>
                <div class="knob-reverb" id="damping">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">damping</p>
                </div>
                <div class="knob-reverb" id="wetLevel">
                    <div class="knob-inner"></div>
                    <p style="margin-left:8px;">wet</p>
                </div>
                <div class="knob-reverb" id="dryLevel">
                    <div class="knob-inner"></div>
                    <p style="margin-left:8px;">dry</p>
                </div>
            </div>
        </div>
        <div class="keyboard">
            <div id="keyboard">
                <ul class="keys">
                    <li class="white-key" id="23" note="C" onclick="sendMidiMessage(this);">
                        <p>C0</p>
                    </li>
                    <li class="black-key" id="24" note="C#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="25" note="D" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="26" note="D#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="27" note="E" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="28" note="F" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="29" note="F#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="30" note="G" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="31" note="G#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="32" note="A" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="33" note="A#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="34" note="B" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="35" note="C" onclick="sendMidiMessage(this);">
                        <p>C1</p>
                    </li>
                    <li class="black-key" id="36" note="C#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="37" note="D" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="38" note="D#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="39" note="E" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="40" note="F" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="41" note="F#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="42" note="G" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="43" note="G#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="44" note="A" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="45" note="A#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="46" note="B" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="47" note="C" onclick="sendMidiMessage(this);">
                        <p>C2</p>
                    </li>
                    <li class="black-key" id="48" note="C#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="49" note="D" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="50" note="D#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="51" note="E" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="52" note="F" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="53" note="F#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="54" note="G" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="55" note="G#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="56" note="A" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="57" note="A#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="58" note="B" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="59" note="C" onclick="sendMidiMessage(this);">
                        <p>C3</p>
                    </li>
                    <li class="black-key" id="60" note="C#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="61" note="D" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="62" note="D#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="63" note="E" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="64" note="F" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="65" note="F#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="66" note="G" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="67" note="G#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="68" note="A" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="69" note="A#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="70" note="B" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="71" note="C2" onclick="sendMidiMessage(this);">
                        <p>C4</p>
                    </li>
                    <li class="black-key" id="72" note="C#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="73" note="D" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="74" note="D#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="75" note="E" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="76" note="F" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="77" note="F#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="78" note="G" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="79" note="G#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="80" note="A" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="81" note="A#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="82" note="B" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="83" note="C2" onclick="sendMidiMessage(this);">
                        <p>C5</p>
                    </li>
                    <li class="black-key" id="84" note="C#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="85" note="D" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="86" note="D#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="87" note="E" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key" id="88" note="F" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="89" note="F#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="90" note="G" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="91" note="G#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="92" note="A" onclick="sendMidiMessage(this);"></li>
                    <li class="black-key" id="93" note="A#" onclick="sendMidiMessage(this);"></li>
                    <li class="white-key offset" id="94" note="B" onclick="sendMidiMessage(this);"></li>
                </ul>
                <input class="slider-regular-down" id="pitch" max="36.0" min="-36.0" name="pitch"
                    oninput="ss.setSoundParameter(this.name, this.value, this.min, this.max)" step="0.01"
                    style="transform: rotate(-90deg);width: 75px; height:20px;" type="range" value="0.0" />
            </div>
            <div class="keyboard-header">
                <div class="left-arrow">
                    <button class="left-arrow-inner" onclick="updateGateTriggerMode(this);"></button>
                </div>
                <div class="outer-box" id="outer-box-keyboard">
                    <div class="inner-box" id="inner-box-launch">
                        <p>gate</p>
                    </div>
                </div>
                <div class="right-arrow">
                    <button class="right-arrow-inner" onclick="updateGateTriggerMode(this);"></button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>