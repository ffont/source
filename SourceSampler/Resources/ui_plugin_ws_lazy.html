<!DOCTYPE html>
<html>

<head>
    <title>Source, a Freesound Commmunity Sampler</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="adsr-envelope/build/adsr-envelope.js"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
    <script src="jQuery-Knob/dist/jquery.knob.min.js"></script>
    <link href="nouislider/dist/nouislider.css" rel="stylesheet">
    <script src="nouislider/dist/nouislider.js"></script>


    <style>

        /** Define global background variable for dark mode switch **/

        :root {
            --background-color: #f2f1f1;
            --font-family :"Lucida Console", "Courier New", monospace;
            --knob-inner-back: linear-gradient(45deg, #dad9d9, #ffffff);
            --knob-inner-shadow:  5px -5px 6px #e3e3e3,-5px 5px 6px #ffffff;
            --general-color : purple;
            --white-keys: #f2f1f1;
            --black-keys: #711771d1;
            --sound-list-button: 5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff;
            --parameter-knobs-shadow: -5px 5px 10px #eaeaea,5px -5px 10px #ffffff;
            --parameter-header-shadow: 5px -5px 2px #ececec, -5px 5px 17px #fff;
            --slider-thumb-shadow: -5px 5px 10px #c2c1c1,5px -5px 10px #ffffff;
            --query-button-shadow: 3px -3px 6px #d3d2d2, -3px 3px 6px #ffffff;
            --waveform-soundlist-shadow: -5px -5px 0px #d4d2d2,5px 5px 100px #ffffff;
            --launch-mode-shadow:  5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff; 
            --parameter-knob-background: #f2f1f1;
            --outer-box-shadow: 5px -5px 10px #c6c0c0, -5px 5px 40px #fffdfd;
            --adsr-header-shadow: rgb(211, 210, 210)0px -5px 10px, rgb(255, 255, 255) -5px 5px 10px;
            --query-text-shadow: inset 5px -5px 10px #dcdbdb,inset -5px 5px 10px #ffffff;
            --slider-track-shadow: -5px 5px 10px #c2c1c1,5px -5px 10px #ffffff;
            --icon-background: purple;
            --icon-shadow: 5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff;
            --white-key-shadow:  -5px 5px 10px #e7e7e7,5px -5px 10px #ffffff;
            --adsr-shadow: rgb(204, 219, 232) 3px 3px 6px 0px inset, rgba(255, 255, 255, 0.5) -3px -3px 6px 1px inset;
            --inner-box-border: #80008033;
            --query-icon: rgba(118, 20, 148, 0.7);
            --black-key-hover: purple;
        }   

        body {
            box-sizing: border-box;
            margin: 20px;
            width:100%;
            height: 100vh;
            font-family: "Lucida Console", "Courier New", monospace;
            display:flex;
            justify-content: center;
            align-items: center;
        }

        .container {
        display: grid;
        box-shadow:  -5px -5px 10px #5a5a5a,
             5px 5px 10px #5a5a5a;
        border-radius: 10px;
        grid-template-columns: repeat(10,1fr);
        grid-template-rows: 1px repeat(10,1fr) 40px;
        grid-template-areas:
            "header header header header"
            "main main . sidebar"
            "footer footer footer footer";
        column-gap: 10px;
        background-color:var(--background-color);
        height: 900px;
        width: 1000px;
        margin-top:  80px;
        margin-bottom: 100px;
        }

        .query-parameters {
            display:grid;
            grid-row: 2/3;
            grid-column: 3/9;
            grid-template-rows: repeat(4,1fr);
            grid-template-columns: repeat(3,1fr);
            margin-top: 100px;

        }

        /**General settings **/
        p {
            user-select: none;
        }


        #q-par {
            display:flex;
            grid-row:3/5;
            grid-column:1/3;
            gap: 40px;
            font-weight: bold;
            font-size: 10px;
            margin-left: 60px;
            height:10px;
        }

        #q-par-labels {
            display:flex;
            grid-row:2;
            height:10px;
            grid-column: 1/5;
            gap:60px;
            margin-left:53px;
            margin-bottom: 15px;
            
        }
        #q-par-labels p {
            font-size:12px;
            font-weight: bold;
        }
        

        .query-search {
            display: flex;
            grid-row: 1/2;
            grid-column:1/4;
            border: none;
            width:100%;
            height: auto;
            background: var(--background-color);
            justify-content: center;
            align-items: center;

        }

        .query-text {
            display:flex;
            justify-content: center;
            align-items: center;
            border: none;
            width:155px;
            height: 30px;
            border-radius: 5px;
            background-color: var(--background-color);
            box-shadow: var(--query-text-shadow);

        }

        input[type="search"]{
            font-family: "Lucida Console", "Courier New", monospace;
            font-size: 12px;
            border: none;
            width:100px;
            height: 20px;
            border-radius: 5px;
            background-color: transparent;
            color: var(--general-color);
        }

        .query-button{
            display:flex;
            width: 40px;
            height: 30px ;
            border-radius: 8px;
            background: var(--background-color);
            box-shadow: var(--query-button-shadow);
            justify-content: center;
            align-items: center;
                    }

        .query-icon{
            width: auto;
            height: auto;

        }

        svg {
            filter: drop-shadow(1px 1px 1px rgba(183, 181, 181, 0.4));

            border-radius: 10px;
            }

        .query-animation {
            transform: scale(1);
            animation: query-pulse 1s infinite;
        }
        @keyframes query-pulse {
            0% {
                transform: scale(0.55);
                box-shadow: 0 0 0 0 var(--query-icon);
            }
            
            70% {
                transform: scale(0.8);
                box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
            }
            }
        
        
        .slider-regular {
            position: relative;
            display: flex;
            width: 100px;
            height: 20px;
            text-align: center;
            justify-content: center;
            border-radius: 5px;
            background: var(--background-color);
            box-shadow:  var(--sound-list-button);
            margin-top:5px;
        }
        .slider-regular-down {
            position: relative;
            display: flex;
            width: 100px;
            height: 20px;
            text-align: center;
            justify-content: center;
            border-radius: 5px;
            background: var(--background-color);
            box-shadow:  var(--sound-list-button);
            margin-top:5px;
        }

        .double-slider,.single-slider {
            width:180px;
            height:20px;
            border: none;
            background-color: transparent;
            margin-top: 5px;
        }


        .single-slider {
            width: 120px;
        }

        .single-slider-octave {
            height: 85px;
            background-color: transparent;
            border: none;

        }

        .single-slider-pitch {
            height: 85px;
            background-color: transparent;
            border: none;

        }

        .noUi-touch-area{
            border-radius: 3px;
            height: 30px;
            width: 25px;
            box-shadow:  var(--slider-thumb-shadow);
            background: var(--background-color);  
            border: none;      
        }
        .noUi-base .noUi-connects {
            justify-content: center;
            border-radius: 5px;
            background: var(--background-color);
            box-shadow:  var(--query-text-shadow);
            border: none;
        }

        .noUi-connect {
            background-color: var(--inner-box-border);
            height: 3px;
            margin-top: 9px;
        }
        
        .noUi-handle {
            border: none;
            border-radius: 5px;
            background-color: transparent;
            cursor: default;
            box-shadow: none;
        }

        .noUi-base .noUi-origin .noUi-handle::after , .double-slider .noUi-base .noUi-origin .noUi-handle::before{
            background:none;
            
        }

        .noUi-handle::before, .noUi-handle::after {
            content: none;
        }

        .noUi-horizontal .noUi-tooltip {
        -webkit-transform: translate(-50%, 0);
        transform: translate(-50%, 0);
        left: 12px;
        bottom: 0px;
        font-size: 9px;
        font-family: "Lucida Console", "Courier New", monospace;
        background: transparent;
        border: none;
        color: var(--general-color);
        }

        .single-slider-octave .noUi-tooltip, .single-slider-pitch .noUi-tooltip {
            top: 12px;
            right:1px;
            background-color: transparent;
            border: none;
            font-size: 10px;
            font-family: "Lucida Console", "Courier New", monospace;
            color: var(--general-color);

        }
        .single-slider-octave .noUi-touch-area, .single-slider-pitch .noUi-touch-area {
            border-radius: 3px;
            height: 20px;
            width: 25px;
            box-shadow: var(--slider-thumb-shadow);
            background: var(--background-color);
            border: none;
        }

        .single-slider-octave .noUi-tooltip {
            right: 7px;
        
        }
        input[type="range"] {
            width:100px;
            background-color: transparent;
        }

        input[type="range"]::-ms-fill-lower {
            background-color: var(--inner-box-border);
            }
        input[type="range"]::-moz-range-progress {
            background-color: var(--inner-box-border);
            }
        input[type="range"]::-webkit-slider-thumb {
            -moz-appearance: none !important;
            appearance: none !important;
            position: relative;
            border-radius: 3px;
            height: 60px;
            width: 20px;
            background: var(--background-color);
            box-shadow:  var(--slider-thumb-shadow);
            cursor: pointer;
            }
        input[type="range"]::-moz-range-thumb {
            -moz-appearance: none !important;
            appearance: none !important;
            position: relative;
            border-radius: 3px;
            height: 30px;
            width: 20px;
            border: none;
            box-shadow:  var(--slider-thumb-shadow);
            background: var(--background-color);
            cursor: pointer;
            }
        .range-text {
                position: absolute;
                top: 4px;
                font-family: "Lucida Console", "Courier New", monospace;
                user-select: none;
                display: flex;
                justify-content: center;
                align-items: center;
                background: transparent;
                text-align: center;
                height: 10px;
                width: 10px;
                margin-left: 80px;
                font-size:10px;
                }


            
        input[type="range"]::-ms-fill-lower{
            background-color: pink;
        }


        *, *::before, *::after {
        box-sizing: border-box;
        }
        :root {
        --colorMain: white;
        --brShadow: -6px 6px 15px rgb(80, 1, 80);
        --tlShadow: 6px -6px 15px rgb(238, 197, 182);
        }

    
        .source-icon{
            display:grid;
            grid-row:1/2;
            grid-column: 1/11;
            transform: rotate(-0deg);
            text-align:center;
            margin-left: 50px;
            margin-top: 55px;
            color: var(--colorMain);
            font-size: 3.8em;
            font-weight: bold;
            font-family: "Lucida Console", "Courier New", monospace;
            text-transform: uppercase;
            text-shadow: var(--brShadow),
                        var(--tlShadow);

            &::before, &::after {
                position: absolute;
                background: var(--colorMain);
                content: '';
                border-radius: 10%;

            }

            &::before {
            left: 0;
            width: 100px;
            height: 100px;
            top: -150px;
            z-index: 10;
            box-shadow: inset var(--brShadow),
                        inset var(--tlShadow) ;

            }
            &::after {
            left: -50px;
            width: 200px;
            height: 200px;
            top: -200px;
            box-shadow: var(--brShadow),
                        var(--tlShadow) ;
            }
        }

        .mode-button {
            grid-column: 5/6;
            width: 50px;
            height: 20px;
            border-radius: 8px;
            background: var(--background-color);
            box-shadow:  var(--sound-list-button);
            margin-top:40px;
            margin-left:125px;
            font-size:12px;
            color: var(--general-color);
            text-shadow: none;

        }
        
        .mode-button p {
            margin-top:1.5px;
        }


        input[type="button"] {
            width: auto;
            height: auto;
            border: none;
        }
        *:focus {
            outline: none;
        }

        .waveform {
            display: grid;
            grid-row: 3/5;
            grid-column: 2/6;
            background: var(--background-color);
            margin-top: 10px;
            border-radius: 10px;
            z-index:1000;
            grid-template-rows: repeat(4,1fr);
            box-shadow:  var(--waveform-soundlist-shadow);

        }
        #waveform {
            grid-row:1/4;
            grid-column: 1/6;
            z-index:4000;
        }

        #waveform wave {
            width: 100%;
            height: 100%;
        }
        .launch-mode {
            display: grid;
            grid-row: 4/5;
            grid-column: 1/6;
            grid-template-columns: repeat(6,1fr);
            background: var(--background-color);
            border-radius: 5px;
            box-shadow: var(--launch-mode-shadow);           
            z-index: 2;
            justify-content: center;
            align-items: center;
        }

        .left-arrow {
            grid-column: 2/3;
            width: 100%;
            height: 100%;
        }

        .left-arrow-inner {
            width: 0;
            height: 0;
            margin-top: 10px;
            margin-left: 25px;
            background: var(--background-color);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right:10px solid var(--icon-background);
        }

        .left-arrow-inner:hover{
            border-right:10px solid var(--inner-box-border);
        }


        .right-arrow {
            grid-column: 5/6;
            width: 100%;
            height: 100%;

        }

        .right-arrow-inner {
            width: 0;
            height: 0;
            margin-top: 10px;
            background: var(--background-color);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-left: 10px solid var(--icon-background);
            margin-left: 15px;

        }

        .right-arrow-inner:hover{
            border-left: 10px solid var(--inner-box-border);
        }

        .outer-box{
            display: grid;
            grid-column: 3/5;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 5%;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 1;
            background: var(--background-color);
            box-shadow: var(--outer-box-shadow);

                                }

        .inner-box {
            display: flex;
            width: 80px;
            height: 25px;
            border: none;
            z-index: 2;
            box-shadow: var(--query-text-shadow);
            border-radius: 5%;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 0.02em solid var(--inner-box-border);
            }

        .outer-box .inner-box p {
            color: var(--general-color);
            font-size: 11px;
        }
        .adsr {
            display:grid;
            grid-row: 5/7;
            grid-column: 2/6;
            box-shadow: var(--adsr-shadow);
            margin-top: 10px;
            border-radius: 10px;
            border: none;
            background-color: transparent;
            align-items: center;

        }

        #adsr-envelope{
            width:100%;
            max-width:100%;
            height:95%;
            border: none;
            }


        .adsr-envelope-knobs {
            display: grid;
            grid-gap:5px;
            grid-row: 7/10;
            grid-column: 2/6;
            grid-template-columns: repeat(4,1fr);
            grid-template-rows: 40px repeat(2,1fr);
            border-radius: 3%;
            background: var(--background-color);
            box-shadow:  var(--parameter-knobs-shadow);
            margin-top: 10px;

        }

        .adsr-header {
            display: grid;
            grid-row:1/2;
            grid-column: 1/6;
            grid-template-columns: repeat(6,1fr);
            background: var(--background-color);
            border-radius: 5px;
            box-shadow: var(--launch-mode-shadow);           
            z-index: 2;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            box-shadow: var(--adsr-header-shadow);
        }


        .adsr-first-knob {
            display: flex;
            grid-row: 2/3;
            grid-column: 1/6;
            gap: 60px;
            margin-left: 15px;
            

        }
        .adsr-second-knob {
            display:flex;
            flex-direction: row;
            grid-row: 3/4;
            grid-column: 1/6;
            margin-left: 65px;
            gap: 60px;

        }

        .canvas {
            display:flex;
        }

        .knob-inner {
            display: flex;
            text-align: center;
            margin-left: 40px;
            width:32px;
            height: 32px;
            margin-top:-60px;
            border-radius: 50px;
            background: var(--knob-inner-back);
            box-shadow:  var(--knob-inner-shadow);
        }

        .knob-1 p,
        .knob-12 p,
        .knob-2000 p,
        .knob-100 p,
        .knob-reverb p{
            font-size: 12px;
            width: 100px;
            font-weight: normal;
            font-family: var(--font-family);
        }


        /***5px 5px 6px #9d9d9d, 5px -5px 70px #fff This is for bumpy knob? what to do**/
        .knob-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0% auto;
            margin-left: 1px;
            border: 1px solid purple;
        }

        .sound-list {
            display:grid;
            grid-row: 3/5;
            grid-column: 6/10;
            margin-top: 10px;
            border-radius: 10px;
            background: var(--background-color);
            grid-template-rows:  repeat(4,1fr);
            grid-template-columns: repeat(2,1fr);
            box-shadow: var(--waveform-soundlist-shadow);
        }

        .sound-list-options {
            display: flex;
            grid-row: 4/5;
            grid-column: 1/4;
            height: 100%;
            background: var(--background-color);
            border-radius: 5px;
            box-shadow: var(--launch-mode-shadow);           
            z-index: 2;
            justify-content: center;
            align-items: center;
            gap:15px;

        }

        .sound-list-buttons {
            display:flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 20px;
            border-radius: 8px;
            background: var(--background-color);
            box-shadow: var(--sound-list-button);
            z-index: 3;
        }

        .remove-icon {
            width: 25px;
            height:10px;
            border-radius: 2px;
            background-color: var(--icon-background);
            box-shadow:  var(--icon-shadow);

        }

        .remove-icon:hover,
        .stop-icon:hover{
            background-color: var(--inner-box-border);
        }

        .stop-icon {
            width: 13px;
            height:13px;
            border-radius: 2px;
            background-color: var(--icon-background);
            box-shadow:  var(--icon-shadow);
        }


        #sound-dropdown {
            grid-row:1/4;
            grid-column:1/3;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 5%;
            background: transparent;
            color: var(--general-color);

        }

        p {
            color: var(--general-color);
        }
        
        .parameter-knobs {
            display: grid;
            grid-row: 5/10;
            grid-column: 6/10;
            grid-template-rows: 40px 65px 40px 65px 40px 65px;
            background: var(--parameter-knob-background);
            box-shadow:  var(--parameter-knobs-shadow);
            margin-top: 10px;
            border-radius: 3%;
            row-gap: 5px;
        }

        .reverb-header {
            grid-row: 1/2;
            text-align: center;
            font-size: 15px;
            display:flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .reverb-knob-area {
            grid-row: 2/3;
            display: flex;
            align-content: center;
            gap:60px;
            margin-left: 20px;
            padding-top: 5px;
            padding-bottom: 5px;
        }

        .modulation-header {
            grid-row:3/4;
            text-align: center;
            font-size:15px;
            display:flex;
            align-items: center;
            justify-content: center;
            text-align: center;
                }

        .modulation-knob-area {
            grid-row: 4/5;
            display: flex;
            gap: 65px;
            margin-left: 65px;
            padding-top: 5px;
            padding-bottom: 5px;
        }
        .velocity-header {
            grid-row: 5/6;
            display:flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 15px;
        }
        .velocity-knob-area{
            grid-row: 6/7;
            display: flex;
            gap: 80px;
            margin-left: 110px;
            padding-top: 5px;
            padding-bottom: 5px;

        }

        .reverb-header p,
        .modulation-header p,
        .velocity-header p {
            box-shadow: var(--parameter-header-shadow);
            border-radius: 5px;
            width:150px;
            height: 20px;

        }

        #keyboard {
            grid-row:10/12;
            grid-column:2/8;
            border: 1px solid black;            
            border-radius: 5%;
            width: auto;
            height: auto;
            border: none;
        }
        #keyboard li:first-child {
            border-radius: 5px 0 5px 5px;
            margin-left:-40px;
            }

        #keyboard li:last-child {
            border-radius: 0 5px 5px 5px;
            }

        .keyboard-arrow {
            border-radius: 25px;
            width:25px;
            height: 25px;
            background-color: var(--background-color);
            box-shadow:  6px 6px 12px #cecdcd,
             -6px -6px 12px #ffffff;
        }
        .white-key,
        .black-key {
            position: relative;
            float: left;
            display: flex;
            user-select: none;
            cursor: pointer;
            text-align: end;
        }

        .white-key:hover {
            box-shadow:  -5px 5px 10px #bdb9b9, 5px -5px 10px #bdb9b9;
        }

        .black-key:hover{
            background-color: var(--black-key-hover);
        }
        .white-key {
            height: 7.5rem;
            width: 2.8rem;
            z-index: 1;
            border-left: 1px solid hsl(0, 0%, 84%);
            border-bottom: 1px solid hsl(0, 0%, 84%);
            border-radius: 0 0 5px 5px;
            background: var(--white-keys);
            box-shadow: var(--white-key-shadow);
            color: var(--black-30);
            }
        .black-key {
            height: 4.5rem;
            width: 1.9rem;
            margin: 0 0 0 -1rem;
            z-index: 2;
            border: 1px solid var(--black-keys);
            border-radius: 0 0 3px 3px;
            box-shadow: -1px -1px 2px var(--white-20) inset,
                0 -5px 2px 3px var(--black-60) inset, 0 2px 4px var(--black-50);
            background: var(--black-keys);
            color: var(--white-50);
            }
            .offset {
            margin: 0 0 0 -1rem;
            }

        .white-key p {
            color: var(--icon-background);
            margin-top: 90px;
            margin-left: 7px;
            font-size: 12px;
        }
        .pitch-section {
            grid-row:10/12;
            grid-column:8/10;
            display: flex;
            align-items: center;
            gap: 0px;
           

        }

        .pitch-div {
            display:flex;
            align-items: center;
            width: auto;
            height: 120px;
        }
        .pitch-div p {
            font-size: 12px;
            margin-top: 130px;
            margin-left: -60px;
        }


    </style>

    <script>


        $(function(){
            $(".knob-1").knob({
                'min':0,
                'max':1,
                'step':0.01,
                'width':45,
                'height':45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset':180,
                'fgColor': 'purple',
                'bgColor':'#dad9d9',
                'font': '"Lucida Console", "Courier New", monospace',
                'change': function(v) {
                    ss.setSoundParameter(this['$'][0]['id'],v,0,1);
                    if (adsrList.includes(this['$'][0]['id'])){
                        drawAdsrEnvelope();
                    }
                }
            });

            $(".knob-reverb").knob({
                'min':0,
                'max':1,
                'step':0.01,
                'width':45,
                'height':45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset':180,
                'fgColor': 'purple',
                'bgColor':'#dad9d9',
                'font': '"Lucida Console", "Courier New", monospace',
                'change': function(v) {
                    //Set reverb parameter to the new value
                    reverbParams[this['$'][0]['id']] = v;
                    ss.setReverbParameters();
                }
            });

            $(".knob-100").knob({
                'min':0,
                'max':100,
                'step':0.01,
                'width':45,
                'height':45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset':180,
                'fgColor': 'purple',
                'bgColor':'#dad9d9',
                'change': function(v) {
                    ss.setSoundParameter(this['$'][0]['id'],v,0,1);
                }
            });


            $(".knob-12").knob({
                'min':-12,
                'max':12,
                'step':0.01,
                'width':45,
                'height':45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset':180,
                'fgColor': 'purple',
                'bgColor':'#dad9d9',
                'change': function(v) {
                    ss.setSoundParameter(this['$'][0]['id'],v,0,1);
                }
            });

            $(".knob-2000").knob({
                'min':10,
                'max':20000,
                'step':1,
                'width':45,
                'height':45,
                'displayInput': true,
                'thickness': 0.2,
                'angleOffset':180,
                'fgColor': 'purple',
                'bgColor':'#dad9d9',
                'change': function(v) {
                    ss.setSoundParameter(this['$'][0]['id'],v,0,1)
                }
            });
        });

       

        let ss = undefined;  // Will keep source plugin state and has util methods to interact with it
        let httpPort = undefined;
        let useHttps = undefined;
        let hostname = undefined;

        //Define a global selected sound
        var selectedSoundUUID = null;

        //Sound list for play and remove
        let playStopSoundList = [];

        //Midi note list to stop previous one
        let midiOnOffList = [];

        //ADSR lists
        let adsrList = ["attack","decay","release","sustain", "filterAttack","filterDecay","filterRelease","filterSustain"]
        let launchModes = ['gate', 'loop', 'loopfb', 'trigger'];

        //Reverb parameters
        let reverbParams = {'roomSize':0, 'damping':0, 'wetLevel':0, 'dryLevel':0, 'width':0,'freezeMode':0}

        //Knob parameters
        let knobParameterNamesAmp = ["attack", "decay", "sustain", "release","gain","pan", 
                                    "mod2CutoffAmt", "mod2GainAmt", "mod2PitchAmt","vel2CutoffAmt", "vel2GainAmt"]
        let knobParameterNamesFilter = ["filterAttack", "filterDecay","filterRelease","filterCutoff","filterRessonance",
                                        "mod2CutoffAmt", "mod2GainAmt", "mod2PitchAmt", "vel2CutoffAmt", "vel2GainAmt"]
        //ADSR initial dictionary
        let DefaultParams = {
                attackTime: 0.1,
                decayTime: 0.1,
                sustainLevel: 0.1,
                releaseTime: 0.1,
                gateTime: 1,
                peakLevel: 1,
                epsilon: 0.001,
                attackCurve: "exp",
                decayCurve: "exp",
                releaseCurve: "exp",
                };

        //Wavecolor
        var wavesurferColor = 'purple';

        var adsrBackgroundColor = '#f2f1f1';


        var expStrength = 2;  // For sliders
        
        window.AudioContext = window.AudioContext || window.webkitAudioContext; // Audio context used for loading audio for drawing waveforms
        const audioContext = new AudioContext();
        
        let lastUIAction = 0;

        var wavesurfer = null;

        var slider = null;
        var singleSlider = null;


        class StateSynchronizer {  // Class to synchronize with plugin's state and interact with it

            constructor(wsPort, useWss) {
                this.state = undefined;
                this.volatileState = undefined;
                this.volatileStateRequestTimer = undefined;
                this.volatileStateRequestTimerInterval = 100;
                this.parser = new DOMParser();

                this.wsPort = wsPort;
                this.useWss = useWss;
                this.wsConnection = this.configureWSConnection();

                this.afterStateUpdatesFullStateRequestTimer = undefined;
                this.afterStateUpdatesFullStateRequestTimerInterval = 1000;
            }

            scheduleExtraFullStateRequestAfterBurstOfMessages () {
                // Because sometimes there can be state syncing issues if messages arrive in wrong orders or due to
                // other whings we did not contemplate, once a burst of state update messages has finished, we call request
                // once more a full state update to make sure everything is perfectly in sync.
                if (this.afterStateUpdatesFullStateRequestTimer !== undefined){
                    clearTimeout(this.afterStateUpdatesFullStateRequestTimer);
                    this.afterStateUpdatesFullStateRequestTimer = undefined;
                }
                this.afterStateUpdatesFullStateRequestTimer = setTimeout(() => {
                    this.requestFullState();
                }, this.afterStateUpdatesFullStateRequestTimerInterval);
            }

            configureWSConnection () {
                let wsUrl = "";
                if (this.useWss){
                    wsUrl = "wss://" + hostname + ":" + this.wsPort + "/source_coms/";
                } else {
                    wsUrl = "ws://" + hostname + ":" + this.wsPort + "/source_coms/";
                }
                console.log("Connecting to WS server: " + wsUrl);
                let socket = new WebSocket(wsUrl);

                let self = this;

                socket.onopen = function(e) {
                    console.log("[WS open] Connection established");

                    // Once connection established, request full state once and start polling volatile state
                    self.requestFullState();
                    self.volatileStateRequestTimer = setInterval(function () {
                        self.requestVolatileState();
                    }, self.volatileStateRequestTimerInterval);
                };

                socket.onclose = function(event) {
                    if (event.wasClean) {
                        console.log(`[WS close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                    } else {
                        console.log('[WS close] Connection died');
                    }
                    setTimeout(() => {
                        self.configureWSConnection (); // Start again connection if it fails, wait 2 seconds
                    }, 2000);

                };

                socket.onerror = function(error) {
                    console.log(`[WS error] ${error.message}`);
                };

                socket.onmessage = function(event) {
                    const msgTypeSeparatorPosition = event.data.indexOf(':');
                    const msgType = event.data.slice(0, msgTypeSeparatorPosition);
                    const rawData = event.data.slice(msgTypeSeparatorPosition + 1, event.data.length);


                    //PROBLEM HERE IS THAT FULL STATE MSG IS COMING BUT VOLATILE IS MORE? HOW TO SOLVE THIS?
                    if (msgType === "/full_state"){
                        const updateIdSeparatorPosition = rawData.indexOf(';');
                        const updateId = parseInt(rawData.slice(0, updateIdSeparatorPosition), 10);
                        const dataToParse = rawData.slice(updateIdSeparatorPosition + 1, rawData.length);
                        self.state = self.parser.parseFromString(dataToParse, "text/xml");
                        updateFullUI();

                    } else if (msgType === "/volatile_state"){
                        self.volatileState = self.parser.parseFromString(rawData, "text/xml");
                        updateVolatileUI();

                    } else if (msgType === "/state_update"){

                        if (ss.state === undefined){
                            // If no state is present, ignore stat update messages as these will fail
                            // also request full state to get in sync again
                            self.requestFullState();
                            return;
                        }

                        const rawDataParts = rawData.split(';');
                        const updateType = rawDataParts[0];
                        const updateId = parseInt(rawDataParts[1], 10);
                        const restOfDataSliced = rawDataParts.slice(2, rawDataParts.length);

                        if (updateType === 'propertyChanged'){
                            const treeUUID = restOfDataSliced[0];
                            const treeType = restOfDataSliced[1];
                            const propertyName = restOfDataSliced[2];
                            const propertyValue = restOfDataSliced[3];

                            const elementToUpdate = self.state.querySelector("[uuid='" + treeUUID + "']");
                            if (elementToUpdate !== null){
                                elementToUpdate.setAttribute(propertyName, propertyValue);


                                // If property was found, trigger corresponding UI updates
                                if (treeType === "SOUND"){
                                    // If what changed is a property of a sound or sound sample, then update the sound list
                                    var sound = ss.getSoundFromSoundUUID(treeUUID);
                                    //If sound exists and not in the deleted mode,
                                    if ((sound !== null) && (propertyName !== "willBeDeleted" && propertyName === "downloadCompleted")){
                                        console.log(propertyName);
                                        updateSoundList(sound.getAttribute('uuid'));
                                    } else {

                                    }

                                    // If the property name is that of a slider (sound parameter), then update the slider as well
                                    if (isSoundParameter(propertyName)){
                                        // NOTE: in that case, treeUUID will always correspond to a SOUND element
                                        updateSoundParameter(treeUUID, propertyName, propertyValue, elementToUpdate);
                                    }
                                } else if (treeType === "SOUND_SAMPLE"){
                                    var sound = ss.getSoundFromSoundSampleUUID(treeUUID);

                                    //If the property belongs to querying, add the sounds to the sound list
                                    if ((sound !== null) && (propertyName !== "willBeDeleted" && propertyName === "downloadCompleted")){
                                        console.log('sound_sample',propertyName);
                                        updateSoundList(sound.getAttribute('uuid'));
                                    } else {
                                        // We might receive property change messages from sounds that are being deleted and that still exist in our state
                                        // We can ignore these messages, but lets print a warning if a message refers to some unexpected property
                                        if (propertyName !== "willBeDeleted"){
                                            console.log('WARNING: property change for unexisting sound different from "willBeDeleted": ', propertyName, propertyValue);
                                        }
                                    }

                                } else if ((treeType === "SOURCE_STATE") || (treeType === "PRESET")){
                                    // If one of the main state or preset state properties changed, update main preset parameters as it will be contained in one of these
                                    updateMainPresetParameters();
                                } else if (treeType === "MIDI_CC_MAPPING"){
                                    updateMIDIMappingEditor(treeUUID);
                                }
                            }

                        } else if (updateType === 'addedChild'){
                            const parentTreeUUID = restOfDataSliced[0];
                            const parentTreeType = restOfDataSliced[1];
                            const indexInParentChildren = parseInt(restOfDataSliced[2], 10);
                            const childXmlString = restOfDataSliced.slice(3, restOfDataSliced.length).join(';');
                            // Add new child element to the state
                            var elementToUpdate;
                            if (parentTreeType === "PRESET"){
                                // If adding child of type preset, add it to the main SOURCE_STATE node regardless of the SOURCE_STATE uuid which some times changes
                                elementToUpdate = ss.state.childNodes[0];
                            } else {
                                elementToUpdate = self.state.querySelector("[uuid='" + parentTreeUUID + "']");
                            }
                            if (elementToUpdate !== null){
                                var nodeToAdd = self.parser.parseFromString(childXmlString, "text/xml").childNodes[0];
                                if (indexInParentChildren < 0){
                                    elementToUpdate.appendChild(nodeToAdd);
                                } else {
                                    var beforeNode = elementToUpdate.childNodes[indexInParentChildren];
                                    elementToUpdate.insertBefore(nodeToAdd, beforeNode);
                                }

                                // If new sounds or midi cc mappings are added, recreate sounds section
                                if ((nodeToAdd.tagName === "MIDI_CC_MAPPING") || (nodeToAdd.tagName === "SOUND")){
                                    updateSoundList();
                                }
                            }

                        } else if (updateType === 'removedChild'){
                            const childToRemoveUUID = restOfDataSliced[0];
                            const childToRemoveType = restOfDataSliced[1];

                            // Remove the selected element from the state
                            const stateElementToRemove = self.state.querySelector("[uuid='" + childToRemoveUUID + "']");
                            if (stateElementToRemove !== null){
                                stateElementToRemove.remove();

                                // Trigger corresponding UI updates
                                const domElementToUpdate = document.getElementById(childToRemoveUUID);
                                if (domElementToUpdate !== null){
                                    domElementToUpdate.remove();
                                }

                                if (childToRemoveType === "SOUND"){
                                    updateAllSoundCardNumbers();
                                }
                            }
                        }

                        self.scheduleExtraFullStateRequestAfterBurstOfMessages();
                    }
                };

                return socket;
            }

            sendMessageToPlugin(address, args){
                const message = address + ':' + args.join(';');
                this.wsConnection.send(message);
            }

            requestFullState(){
                this.sendMessageToPlugin('/get_state', ["full"]);
            }

            requestVolatileState(){
                this.sendMessageToPlugin('/get_state', ["volatile"]);
            }

            // Util methods to get state info

            getSounds(){
                return ss.state.getElementsByTagName('SOUND');
            }

            getSoundSamplerSounds(sound){  // sound = sound xml state
                if (sound !== null){
                    return sound.getElementsByTagName('SOUND_SAMPLE');
                } else {
                    return [];
                }

            }

            getFirstSoundSampleSound(sound) {  // sound = sound xml state
                return this.getSoundSamplerSounds(sound)[0];
            }

            getSoundFromSoundUUID(soundUUID){
                return ss.state.querySelector("[uuid='" + soundUUID + "']");
            }

            getSoundFromSoundSampleUUID(soundSampleUUID){
                const soundSample = ss.state.querySelector("[uuid='" + soundSampleUUID + "']");
                return ss.getSoundFromSoundUUID(soundSample.parentElement.getAttribute('uuid'));
            }

            getMidiMappingStateFromMappingUUID(mappingUUID){
                return ss.state.querySelector("[uuid='" + mappingUUID + "']");
            }

            getSoundMidiMappings(sound){  // sound = sound xml state
                return sound.getElementsByTagName('MIDI_CC_MAPPING');
            }

            findSoundIdxFromSoundUUID(soundUUID){
                var sounds = ss.getSounds();
                for (var i=0; i<sounds.length; i++) {
                    if (sounds[i].getAttribute("uuid") == soundUUID){
                        return i + 1;
                    }
                }
                return -1
            }

            findSoundIdxFromSourceSamplerSoundUUID(samplerSoundUUID){
                var sounds = ss.getSounds();
                for (var i=0; i<sounds.length; i++) {
                    var samplerSounds = this.getSoundSamplerSounds(sounds[i]);
                    for (var j=0; j<samplerSounds.length; j++) {
                        var samplerSound = samplerSounds[j];
                        if (samplerSound.getAttribute("uuid") == samplerSoundUUID){
                            return i + 1;
                        }
                    }
                }
                return -1
            }

            getTmpFilesLocation(){
                return this.state.getElementsByTagName('SOURCE_STATE')[0].getAttribute('tmpFilesLocation');
            }

            // Util methods to change things of the state

            setSoundParameter(parameterName, parameterVal, parameterMin, parameterMax){
                saveCurrentUserActionTime();
                this.sendMessageToPlugin('/set_sound_parameter', [selectedSoundUUID, parameterName, getProcessedSoundParameterValuLinToExp(parameterName,parameterVal, parameterMin, parameterMax)])
            }

            setSoundParameterInt(elementName, val){
                saveCurrentUserActionTime();
                this.sendMessageToPlugin('/set_sound_parameter_int', [selectedSoundUUID, elementName, val]);
            }

            getSoundParameterValue(soundUUID, soundParameterName){
                let sound = this.getSoundFromSoundUUID(soundUUID);
                let soundParameterVal = sound.getAttribute(soundParameterName);
                return soundParameterVal;
            }

            addSoundsByQuery(){
                var query = document.getElementsByName('query')[0].value;
                var numSounds = $('.single-slider')[0].noUiSlider.get()[0];
                var minSoundLength = $('.double-slider')[0].noUiSlider.get()[0];
                var maxSoundLength = $('.double-slider')[0].noUiSlider.get()[1];            
                var noteLayoutType = $('#noteLayout p').text(); 
                this.sendMessageToPlugin('/add_sounds_from_query', [query, numSounds, minSoundLength, maxSoundLength,noteLayoutType])
            }

            reapplyLayout(noteMappingType){
                this.sendMessageToPlugin('/reapply_layout', [noteMappingType]);
            }

            clearAllSounds(){
                this.sendMessageToPlugin('/clear_all_sounds', [])
            }

            setMidiInChannel() {
                var midiInChannel = document.getElementsByName('midiInChannel')[0].value;
                this.sendMessageToPlugin('/set_midi_in_channel', [midiInChannel])
            }

            setReverbParameters() {
                var reverbParameterList = Object.keys(reverbParams).map(function(key){
                    return reverbParams[key];
                })
                this.sendMessageToPlugin('/set_reverb_parameters', reverbParameterList)
            }

            setNumVoices() {
                var numVoices = document.getElementsByName('numVoices')[0].value;
                this.sendMessageToPlugin('/set_polyphony', [numVoices])
            }

            playSound(){

                //Add sound to the list to stop if a new sound is selected
                playStopSoundList.push(selectedSoundUUID);


                if (playStopSoundList.length > 1) {
                    //Stop the previous sound and remove it
                    ss.stopSound(playStopSoundList[0]);
                    playStopSoundList.shift();
                }
                var sound = ss.getSoundFromSoundUUID(selectedSoundUUID);
                var samplerSounds = ss.getSoundSamplerSounds(sound);

                this.sendMessageToPlugin('/play_sound', [selectedSoundUUID])

            }

            stopSound(soundUUID){
                
                //Kind of a hack for stopping sound from the button below sound list
                if (soundUUID === 'stop') {
                    var soundUUID = selectedSoundUUID;
                }
                this.sendMessageToPlugin('/stop_sound', [soundUUID])
            }

            removeSound(soundUUID){
                this.sendMessageToPlugin('/remove_sound', [soundUUID])
            }

            savePreset(){
                var name = document.getElementsByName('presetName')[0].value;
                var idx = document.getElementsByName('presetIdx')[0].value;
                this.sendMessageToPlugin('/save_preset', [name, idx])
            }

            loadPreset() {
                var idx = document.getElementsByName('presetIdx')[0].value;
                this.sendMessageToPlugin('/load_preset', [idx])
            }

            nextPreset(){
                var idx = document.getElementsByName('presetIdx')[0].value;
                if (idx == undefined){
                    idx = -1;
                } else {
                    idx = parseInt(idx, 10);
                    if (isNaN(idx)){
                        idx = -1;
                    }
                }
                this.sendMessageToPlugin('/load_preset', [idx + 1])
            }

            sendMidiNoteOn(rootNote){
                this.sendMessageToPlugin('/note_on',[rootNote, 120, 0]);
            }

            sendMidiNoteOff(rootNote){
                this.sendMessageToPlugin('/note_off', [rootNote, 120, 0]);
            }


            previousPreset(){
                var idx = document.getElementsByName('presetIdx')[0].value;
                if (idx == undefined){
                    idx = 1;
                } else {
                    idx = parseInt(idx, 10);

                    if (isNaN(idx)){
                        idx = 1;
                    }
                }
                if (idx < 1){
                    idx = 1; //Will become 0 when subtracted 1
                }
                this.sendMessageToPlugin('/load_preset', [idx - 1])
            }

            rootNote(){
                var sound = ss.getSoundFromSoundUUID(selectedSoundUUID);
                var samplerSounds = ss.getSoundSamplerSounds(sound);
                var samplerSound = samplerSounds[0];
                this.sendMessageToPlugin('/set_sampler_sound_root_note',[selectedSoundUUID,samplerSound.getAttribute('uuid'),60]);

            }


            createUpdateMapping(soundUUID, mappingID){
                var ccNumber = document.getElementById(mappingID + '_mappingCCNumber').value;
                var name = document.getElementById(mappingID + '_mappingParameterName').value;
                var minRange = parseFloat(document.getElementById(mappingID + '_mappingMinRange').value, 10);
                var maxRange = parseFloat(document.getElementById(mappingID + '_mappingMaxRange').value, 10);
                this.sendMessageToPlugin('/add_or_update_cc_mapping', [soundUUID, mappingID, ccNumber, name, minRange, maxRange]);
                if (mappingID == ""){
                    // Remove this element from DOM because this one is only while creating a new mappping
                    document.getElementById('newMappingPlaceholder_' + soundUUID).innerHTML = "";
                }
            }

            removeMidiMapping(soundUUID, mappingID){
                if (mappingID != ""){
                    this.sendMessageToPlugin('/remove_cc_mapping', [soundUUID, mappingID]);
                    // No need to remove the element itself because it will be removed when updating state
                } else {
                    document.getElementById('newMappingPlaceholder_' + soundUUID).innerHTML = "";  // Remove new mapping palceholder as the mapping was not yet created
                }
            }

        }

        document.addEventListener("DOMContentLoaded", function () {

            // Main funciont: reads some configuration properties form the URL and starte the StateSynchronizer
            // Once the StateSyncronizer is started, it will start to receive updates when changes happen in
            // the plugin's state. These updates will triger renders of appropriate parts of the UI.



            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            // If hostname is passed as a parameter, use it for WS and HTTP communications
            // Otherwise set it to the hostname of the current location
            if (urlParams.get('hostname') !== null){
                hostname = urlParams.get('hostname');
            } else {
                if (location.hostname !== ""){
                    hostname = location.hostname;
                } else {
                    hostname = 'localhost';
                }
            }

            // Get websockets/http connection config parameters (or use defaults)
            if (urlParams.get('wsPort') !== null){
                wsPort = urlParams.get('wsPort');
            } else {
                wsPort = "8125";
            }
            if (urlParams.get('useWss') !== null){
                useWss = urlParams.get('useWss') == '1';
            } else {
                useWss = false;
            }
            if (urlParams.get('httpPort') !== null){
                httpPort = urlParams.get('httpPort');
            } else {
                httpPort = "8124";
            }
            useHttps = useWss;


            // Start state synchronizer
            ss = new StateSynchronizer(wsPort, useWss);

            //Initialize the ADSR Envelope
            drawAdsrEnvelope();
            
            //Remove all the sounds from previous session
            ss.clearAllSounds();

            

        });

        // Util methods  

        function updateOctave(obj){
                var octaveVal = obj.value;
                var keyboardParent = document.getElementById('keyboard');
                var keyboardOctaveVal = keyboardParent.children[0].textContent.split("")[1];
                    for(var i=0; i < keyboardParent.children.length; i++){
                        keyboardParent.children[i].id = 12 * (parseInt(octaveVal) + 2) + i;
                    }        
                
                keyboardParent.children[0].children[0].textContent = "C"+octaveVal;
                keyboardParent.children[12].children[0].textContent = "C"+(parseInt(octaveVal)+1);
                
            } 
        

        function sendMidiMessage(obj){


            if (obj){
            var midiNote = obj.id;

            var launchMode = $("#outer-box-launch > #inner-box-launch > p").text();
            
            //If mode is gate, the sound should stop as soon as key is released
            var int00 = 0;
            if (launchMode === "gate"){ 
                $('#'+obj.id).mousedown(function(){
                        ss.sendMidiNoteOn(midiNote); 
                        int00 = setInterval(function() { console.log('hold..'); }, 50);
                    }).mouseup(function() {
                        clearInterval(int00);
                        ss.sendMidiNoteOff(midiNote);
                    });

            }else{
                ss.sendMidiNoteOff(midiOnOffList[0]);
                midiOnOffList.push(midiNote);
                ss.sendMidiNoteOn(midiNote);

                if (midiOnOffList.length > 1) {
                    //Stop the previous sound and remove it
                    midiOnOffList.shift();
                }
                if (midiOnOffList[1]){
                    ss.sendMidiNoteOn(midiOnOffList[1]);
                }
            }
            }else{
                ss.stopSound();
            }
        
        }

        function updateGlobalSoundUUID(){
            //Update the global sound UUID
            selectedSoundUUID = $("select#sound-dropdown option").filter(':selected').data('uuid');

            //Draw the ADSR Envelope for the selected sound
            drawAdsrEnvelope();

            //Draw the waveform for the selected sound
            drawSoundWaveform();

            //Update the sliders with the new sound
            updateAllParameterElements();

            //Reset the launch mode
            resetLaunchMode();

            //Set midi root of the selected sound
        };

        function updateAllParameterElements(){
            updateKnobElements();

        }

        function updateKnobElements(){
            //A workaround for filter/amplitude ADSR selection
            if ($('#attack') !== null){
                var iterateList = knobParameterNamesAmp;
            } else {
                var iterateList = knobParameterNamesFilter;
            }
            for (var i=0; i < iterateList.length;i++){
                var element = iterateList[i];
                var elementVal = ss.getSoundParameterValue(selectedSoundUUID, element);
                $('#'+element).val(elementVal).trigger('change');
            }
        }

        function updateFilterADSR(){
            var iterateList = ['filterAttack','filterDecay','filterRelease','filterSustain'];
            for (var i=0; i < iterateList.length;i++){
                var element = iterateList[i];
                var elementVal = ss.getSoundParameterValue(selectedSoundUUID, element);
                $('#'+element).val(elementVal).trigger('change');
            }

        }

        function updateAmplitudeADSR(){
            var iterateList = ['attack','decay','release','sustain'];
            for (var i=0; i < iterateList.length;i++){
                var element = iterateList[i];
                var elementVal = ss.getSoundParameterValue(selectedSoundUUID, element);
                $('#'+element).val(elementVal).trigger('change');
            }        }

        window.onload = function(){
            var rangeInput = document.getElementById('q-par');
            rangeInput.addEventListener('click',function() {
                const isInput = event.target.nodeName === 'INPUT';
                var rangeTextName = event.target.id;
                var rangeText = document.getElementById('range-text-'+rangeTextName);
                if (rangeText !== null){
                    let newVal = event.target.value;
                    rangeText.innerHTML = newVal; //Set range text equal to input position
            
            

                }
            })
            slider = $('.double-slider');

            noUiSlider.create(slider[0], {
                start: [0, 90],
                step: 1,
                connect: true,
                tooltips:true,
                format: wNumb({decimals: 0}),
                range: {
                    'min': 0,
                    'max': 100,
                },
                
        });
        singleSlider = $('.single-slider');

        noUiSlider.create(singleSlider[0], {
            start: 1,
            step: 1,
            connect: true,
            tooltips:true,
            format: wNumb({decimals: 0}),
            range: {
                'min': 1,
                'max': 20,
            },
            
        });
        
        }

        function switchColorModes(obj){
            if ($('.mode-button').attr('value') === "0"){
                var newVal = "1";
                var newBackground = '#3e424a';
                var newInnerKnobBack = 'linear-gradient(145deg, #42474f, #383b43)';
                var newInnerKnobShadow = '8px -8px 16px #191a1e,-8px 8px 16px #636a76';
                var newGeneralColor = 'white';
                var newBlackKeys = '#3e424a';
                var newSoundListButton = "-7px 7px 14px #2b2e34,7px -7px 14px #515660";
                var newParameterKnobShadow = "-5px 5px 10px #33363d,5px -5px 10px #494e57";
                var newParameterHeaderShadow = "8px -8px 16px #1b1f20,-8px 8px 16px #41494c";
                var newSliderThumbShadow = "7px 7px 19px #1a1c1f, -7px -7px 19px #626875";
                var newQueryButtonShadow = "8px -8px 16px #1b1f20,-8px 8px 16px #41494c";
                var newWaveformShadow = "inset 6px -6px 12px #272c2e,inset -6px 6px 12px #353c3e";
                var newLaunchModeShadow = "-5px -5px 10px #222429,5px 5px 200px #5a606b";
                var newBrShadow = "-6px 6px 15px rgba(95, 185, 185, 1)";
                var newtlShadow = "6px -6px 15px rgba(95, 185, 185)";
                var newParameterKnobBackground = "linear-gradient(225deg, #42474f, #383b43)";
                var newLaunchOuterBoxShadow = "-5px -5px 10px #222429,5px 5px 10px #5a606b";
                var newAdsrHeaderShadow ="-5px -5px 10px #222429,5px 5px 200px #5a606b";
                var newQueryTextShadow = "inset 5px 5px 3px #35383f,inset -5px -5px 3px #474c55";
                var newSliderTrackShadow = "5px 5px 10px #1f2125, -5px -5px 15px #5d636f";
                var newIconShadow = "none";
                var newIconBackground = "#838486";
                var newWhiteKeyShadow = "-1px 1px 5px #b7b7b6, 1px -1px 5px #fff";
                var newAdsrShadow = "inset 6px -6px 12px #272c2e,inset -6px 6px 12px #353c3e";
                var newInnerBoxBorder = "#5fb9b9a1";
                var newQueryIcon = "#5fb9b9a1";
                var newBlackHover = "black";


                //Change the waveform color
                wavesurferColor = '#5fb9b9a1';

                //Change the background of ADSR Envelope
                adsrBackgroundColor = '#3e424a';


                //Change the progress color of knobs
                $(".knob-1,.knob-100,.knob-12,.knob-2000,.knob-reverb").trigger('configure', 
                {
                'fgColor': 'cyan',
                }
                );
                if (wavesurfer){
                    wavesurfer.setWaveColor('#5fb9b9a1');
                }

                if (selectedSoundUUID) {
                    drawAdsrEnvelope();
                }
           
            }else{
                var newVal = "0";
                var newBackground = '#f2f1f1';
                var newInnerKnobBack = 'linear-gradient(45deg, #dad9d9, #ffffff)';
                var newInnerKnobShadow = '5px -5px 6px #e3e3e3,-5px 5px 6px #ffffff';
                var newGeneralColor = 'purple';
                var newBlackKeys = '#711771d1';
                var newSoundListButton = "5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff";
                var newParameterKnobShadow = "-5px 5px 10px #eaeaea, 5px -5px 10px #ffffff";
                var newParameterHeaderShadow = "5px -5px 2px #ececec, -5px 5px 17px #fff";
                var newQueryButtonShadow = "3px -3px 6px #d3d2d2,-3px 3px 6px #ffffff";
                var newWaveformShadow = "-5px -5px 0px #d4d2d2,5px 5px 100px #ffffff";
                var newLaunchModeShadow = "5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff";
                var newBrShadow = "-6px 6px 15px rgb(80, 1, 80)";
                var newtlShadow = "6px -6px 15px rgb(238, 197, 182)";
                var newParameterKnobBackground = "#f2f1f1";
                var newLaunchOuterBoxShadow = "5px -5px 10px #c6c0c0, -5px 5px 40px #fffdfd";
                var newAdsrHeaderShadow = "rgb(211, 210, 210)0px -5px 10px, rgb(255, 255, 255) -5px 5px 10px";
                var newQueryTextShadow = "inset 5px -5px 10px #dcdbdb,inset -5px 5px 10px #ffffff";
                var newSliderTrackShadow = " -5px 5px 10px #32353b,5px -5px 10px #4a4f59";
                var newSliderThumbShadow = "-5px 5px 10px #c2c1c1,5px -5px 10px #ffffff";
                var newWhiteKeyShadow = " -5px 5px 10px #e7e7e7,5px -5px 10px #ffffff";
                var newAdsrShadow = "rgb(204, 219, 232) 3px 3px 6px 0px inset, rgba(255, 255, 255, 0.5) -3px -3px 6px 1px inset"; 
                var newIconBackground = "purple";
                var newIconShadow = " 5px -5px 10px #d3d2d2,-5px 5px 10px #ffffff";
                var newInnerBoxBorder = "#80008033";
                var newQueryIcon = "rgba(118, 20, 148, 0.7)";
                var newBlackHover = "purple";

                wavesurferColor = 'purple;'
                adsrBackgroundColor = '#f2f1f1';

                if (wavesurfer){
                    wavesurfer.setWaveColor('purple');
                }

                $(".knob-1,.knob-100,.knob-12,.knob-2000,.knob-reverb").trigger('configure', 
                {
                'fgColor': 'purple',
                }
                );

                if (selectedSoundUUID){
                    drawAdsrEnvelope();
                }


            }
            document.documentElement.style.setProperty('--background-color', newBackground);
            document.documentElement.style.setProperty('--knob-inner-back', newInnerKnobBack);
            document.documentElement.style.setProperty('--knob-inner-shadow', newInnerKnobShadow);
            document.documentElement.style.setProperty('--general-color', newGeneralColor);
            document.documentElement.style.setProperty('--black-keys',newBlackKeys);
            document.documentElement.style.setProperty('--sound-list-button',newSoundListButton);
            document.documentElement.style.setProperty('--parameter-knobs-shadow',newParameterKnobShadow);
            document.documentElement.style.setProperty('--parameter-header-shadow',newParameterHeaderShadow);
            document.documentElement.style.setProperty('--query-button-shadow', newQueryButtonShadow);
            document.documentElement.style.setProperty('--waveform-soundlist-shadow', newWaveformShadow);
            document.documentElement.style.setProperty('--launch-mode-shadow',newLaunchModeShadow);
            document.documentElement.style.setProperty('--brShadow',newBrShadow);
            document.documentElement.style.setProperty('--tlShadow', newtlShadow);
            document.documentElement.style.setProperty('--parameter-knob-background', newParameterKnobBackground);
            document.documentElement.style.setProperty('--outer-box-shadow', newLaunchOuterBoxShadow);
            document.documentElement.style.setProperty('--adsr-header-shadow',newAdsrHeaderShadow);
            document.documentElement.style.setProperty('--query-text-shadow', newQueryTextShadow);
            document.documentElement.style.setProperty('--slider-track-shadow', newSliderTrackShadow);
            document.documentElement.style.setProperty('--slider-thumb-shadow', newSliderThumbShadow);
            document.documentElement.style.setProperty('--icon-background',newIconBackground);
            document.documentElement.style.setProperty('--icon-shadow',newIconShadow);
            document.documentElement.style.setProperty('--white-key-shadow', newWhiteKeyShadow);
            document.documentElement.style.setProperty('--adsr-shadow', newAdsrShadow);
            document.documentElement.style.setProperty('--inner-box-border', newInnerBoxBorder);
            document.documentElement.style.setProperty('--query-icon', newQueryIcon);
            document.documentElement.style.setProperty('--black-key-hover', newBlackHover);
            $('.mode-button').attr('value',newVal);



        }   

        function updateReverseState(){
            var val = $('#reverse').attr('value');
            if (val === 1){
                $('#reverse').attr('value',0);
                ss.setSoundParameterInt('reverse',val);
                ss.playSound();
                return null;
            }else{
                $('#reverse').attr('value',1);
                ss.setSoundParameterInt('reverse',val);
                ss.playSound();
                return null;
                        }



        }
        function saveCurrentUserActionTime(){
            lastUIAction = (new Date()).getTime();
        }

        function msSinceLastUserAction(){
            return (new Date()).getTime() - lastUIAction;
        }

        function linToExp(x){
            return (Math.pow(x,expStrength));
        }

        function expToLin(x){
            return (Math.pow(x,1/expStrength));
        }

        function sliderShouldBehaveExponentially(sliderElement){
            var name = sliderElement.name;
            if (name != null){
                if ((name.toLowerCase().indexOf("attack") > -1) ||
                    (name.toLowerCase().indexOf("decay") > -1) ||
                    (name.toLowerCase().indexOf("release") > -1) ||
                    (name == "filterCutoff")
                ){
                    return true;
                }
            }

            return false;
        }

        function getProcessedSoundParameterValuLinToExp(parameterName, parameterVal, parameterMin, parameterMax){
            var value = parseFloat(parameterVal, 10);
            return value;
        }

        function getProcessedSoundParameterValueExpToLin(sliderElement, valueRaw){
            if (sliderShouldBehaveExponentially(sliderElement) == true){
                return expToLin(valueRaw/sliderElement.max)*sliderElement.max;
            } else {
                return valueRaw;
            }
        }

        function getMidiControllableParameterNames(){
            // --> Start auto-generated code B
            parameterNames = ["startPosition", "endPosition", "loopStartPosition", "loopEndPosition", "playheadPosition", "freezePlayheadSpeed", "filterCutoff", "filterRessonance", "gain", "pan", "pitch"]
            // --> End auto-generated code B
            return parameterNames;
        }

        function getAllSoundParameterNames(){
            // --> Start auto-generated code C
            parameterNames = ["launchMode", "startPosition", "endPosition", "loopStartPosition", "loopEndPosition", "loopXFadeNSamples", "reverse", "noteMappingMode", "numSlices", "playheadPosition", "freezePlayheadSpeed", "filterCutoff", "filterRessonance", "filterKeyboardTracking", "filterAttack", "filterDecay", "filterSustain", "filterRelease", "filterADSR2CutoffAmt", "gain", "attack", "decay", "sustain", "release", "pan", "pitch", "pitchBendRangeUp", "pitchBendRangeDown", "mod2CutoffAmt", "mod2GainAmt", "mod2PitchAmt", "mod2PlayheadPos", "vel2CutoffAmt", "vel2GainAmt", "midiChannel"]
            // --> End auto-generated code C
            return parameterNames;
        }

        function isSoundParameter(parameterName){
            return getAllSoundParameterNames().indexOf(parameterName) > -1;
        }

        function getAllSoundParameterTypes(){
            // --> Start auto-generated code D
            parameterTypes = ["int", "float", "float", "float", "float", "int", "int", "int", "int", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "float", "int"]
            // --> End auto-generated code D
            return parameterTypes;
        }

        function getParameterType(parameterName){
            return getAllSoundParameterTypes()[getAllSoundParameterNames().indexOf(parameterName)];
        }

        // Methods to update different parts of the UI


        function addNewMIDIMappingEditor(soundUUID) {
                document.getElementById('newMappingPlaceholder_' + soundUUID).innerHTML = createMIDIMappingEditorFromRawParams(soundUUID, "", 0, "", 0.0, 1.0);
            }

        function createMIDIMappingEditor(soundUUID, mapping){ // mapping xml form state
            var mappingUUID = mapping.getAttribute('uuid');
            var ccNumber = parseInt(mapping.getAttribute('ccNumber'), 10);
            var name = mapping.getAttribute('parameterName');
            var minRange = parseFloat(mapping.getAttribute('minRange'), 10);
            var maxRange = parseFloat(mapping.getAttribute('maxRange'), 10);
            return createMIDIMappingEditorFromRawParams(soundUUID, mappingUUID, ccNumber, name, minRange, maxRange);
        }

        function createMIDIMappingEditorFromRawParams(soundUUID, mappingUUID, ccNumber, parameterName, minRange, maxRange){
            html = '<div id="' + mappingUUID + '" data-sound-id="' + soundUUID + '" class="midiMapping">';
            html += 'CC number: <input id="' + mappingUUID + '_mappingCCNumber" value="' + ccNumber + '" type="number"><br>';
            html += 'Parameter: <select class="select-css" id="' + mappingUUID + '_mappingParameterName">';
            var availableParams = getMidiControllableParameterNames();
            for (var i=0; i<availableParams.length; i++){
                if (availableParams[i] != parameterName){
                    html += '<option value="' + availableParams[i] + '">&nbsp;&nbsp;' + availableParams[i] + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>';
                } else {
                    html += '<option value="' + availableParams[i] + '" selected>&nbsp;&nbsp;' + availableParams[i] + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>';
                }
            }
            html += '</select><br>';
            html += '<input type="range" id="' + mappingUUID + '_mappingMinRange"  min="0" max="1.0" value="' + minRange + '" step="0.01"> min: <span id="' + mappingUUID + '_mappingMinRangeLabel"></span><br>';
            html += '<input type="range" id="' + mappingUUID + '_mappingMaxRange"  min="0" max="1.0" value="' + maxRange + '" step="0.01"> max: <span id="' + mappingUUID + '_mappingMaxRangeLabel"></span><br>';
            html += '<button onclick="ss.createUpdateMapping(\'' + soundUUID + '\',\'' + mappingUUID + '\')">save</button><button onclick="ss.removeMidiMapping(\'' + soundUUID + '\',\'' + mappingUUID + '\')">x</button>';
            html += '</div>';
            return html;
        }
        function updateSoundParameter(soundUUID, parameterName, parameterValue){
            const sliderElement = document.getElementById(soundUUID + '_' + parameterName);
            if (sliderElement === null){
                return;
            }
            if (parameterValue === undefined){
                var sound =  ss.getSoundFromSoundUUID(soundUUID);
                parameterValue = sound.getAttribute(parameterName);
            }
            const parameterType = getParameterType(parameterName);
            if (parameterType == "float"){
                sliderElement.value = getProcessedSoundParameterValueExpToLin(sliderElement, parseFloat(parameterValue, 10));
            } else if (parameterType == "int"){
                sliderElement.value = parseInt(parameterValue, 10);
            }
            updateSliderLabel(sliderElement);
        }

        function updateMIDIMappingEditor(mappingUUID){
            var mapping = ss.getMidiMappingStateFromMappingUUID(mappingUUID);
            var ccNumber = parseInt(mapping.getAttribute('ccNumber'), 10);
            var name = mapping.getAttribute('parameterName');
            var minRange = parseFloat(mapping.getAttribute('minRange'), 10);
            var maxRange = parseFloat(mapping.getAttribute('maxRange'), 10);

            document.getElementById(mappingUUID + '_mappingCCNumber').value = ccNumber;
            document.getElementById(mappingUUID + '_mappingParameterName').value = name;
            document.getElementById(mappingUUID + '_mappingMinRange').value = minRange;
            document.getElementById(mappingUUID + '_mappingMinRangeLabel').innerHTML = minRange;
            document.getElementById(mappingUUID + '_mappingMaxRange').value = maxRange;
            document.getElementById(mappingUUID + '_mappingMaxRangeLabel').innerHTML = maxRange;
        }

        function updateAllSoundCardNumbers() {
            var sounds = ss.getSounds();
            for (i=0; i<sounds.length; i++) {
                var soundUUID = sounds[i].getAttribute('uuid');
                var soundCard = document.getElementById(soundUUID + '_idx');
                if (soundCard !== null){
                    soundCard.innerHTML =  document.getElementById(soundUUID).dataset.soundIdx;
                }
            }
        }

       function changeADSRElementId(){
        var adsrMode = $('#outer-box-adsr #inner-box-launch p').text();
           if (adsrMode === 'amplitude'){
               $('#attack').attr("id","filterAttack");
               $('#decay').attr("id","filterDecay");
               $('#sustain').attr("id","filterSustain");
               $('#release').attr("id", "filterRelease");
               $('#gain').attr("id","filterCutoff");
               $('#filterCutoff>p').text("cutoff");
               $('#filterCutoff').trigger('configure', {
                'min':10,
                'max':20000,
               });
               $('.filterADSR2CutoffAmt').css('visibility','visible');
               $('#pan').attr("id","filterRessonance");
               $('#filterRessonance').trigger('configure', {
                'min':0,
                'max':1,
               });
               $('#filterRessonance>p').text("ressonance");
               updateFilterADSR();
               var newAdsrText = 'filter';
           }else{
               $('#filterAttack').attr("id","attack");
               $('#filterDecay').attr("id","decay");
               $('#filterSustain').attr("id","sustain");
               $('#filterRelease').attr("id", "release");
               $('#filterCutoff').attr("id","gain");
               $('#gain').trigger('configure', {
                'min':-80,
                'max':12,
               });
               
               $('#gain>p').text('gain');
               $('.filterADSR2CutoffAmt').css('visibility','hidden');
               $('#filterRessonance').attr("id","pan");
               $('#pan>p').text("pan");
               $('#pan').trigger('configure', {
                'min':-1,
                'max':1,
               });
               var newAdsrText = 'amplitude';
            }
            $('#outer-box-adsr #inner-box-launch p').text(newAdsrText);

               //Only update for ADSR elements should be added
               updateAmplitudeADSR();
           }
       
       function changeNoteLayout(){
            if ($('#noteLayout p').text() === 'contiguous'){
                var newNoteLayout = 'interleaved';
                var noteLayoutVal = 1;
            }else {
                var newNoteLayout = 'contiguous';
                var noteLayoutVal = 0;
            }
            $('#noteLayout p').text(newNoteLayout);
            ss.reapplyLayout(noteLayoutVal);
       }


        function updateMainPresetParameters(){
            var sourceState = ss.state.getElementsByTagName('SOURCE_STATE')[0];
            document.getElementsByName('presetIdx')[0].value = sourceState.getAttribute('currentPresetIndex');
            document.getElementsByName('midiInChannel')[0].value = sourceState.getAttribute('globalMidiInChannel');

            var presetState = sourceState.getElementsByTagName('PRESET')[0];
            document.getElementsByName('presetName')[0].value = presetState.getAttribute('name');
            document.getElementsByName('numVoices')[0].value = presetState.getAttribute('numVoices');

        }

        function resetLaunchMode(){
            $("#outer-box-launch > #inner-box-launch > p").text('gate');
        }

        function updateLaunchMode(obj) {
            var currentMode = $("#outer-box-launch > #inner-box-launch > p").text();
            var currentModeIndex = launchModes.indexOf(currentMode.toLowerCase());
            var nextModeIndex = currentModeIndex;

            //Get the direction of arrow
            var direction = obj.className;
            if (direction == 'left-arrow-inner'){
                    nextModeIndex = currentModeIndex - 1;
                    if (nextModeIndex < 0) {
                        nextModeIndex = 3;
                    }

                }else{
                    nextModeIndex = currentModeIndex + 1;
                    if (nextModeIndex == 4) {
                        nextModeIndex = 0;
                    }
                }
            //If the mode is gate or trigger, play all sound


            var newText = launchModes[nextModeIndex];
            if (['trigger','gate'].includes(newText)){
                wavesurfer.regions.clear();
                ss.setSoundParameter('startPosition',0,0,1);
                ss.setSoundParameter('endPosition',1,0,1);
            }

            if (['loop','loopfb'].includes(newText)){
                wavesurfer.regions.clear();
                //Get the duration to create fitting region
                var soundLength = wavesurfer.backend.getDuration();
                wavesurfer.addRegion({ 
                                start: 0,
                                end: soundLength/4,
                                loop: false,
                                color: 'hsla(400, 100%, 30%, 0.5)'
                                    })
            
            wavesurfer.on('region-updated', region =>{

                    //Set the start and end of the looped sound
                    ss.setSoundParameter('startPosition', region.start/soundLength,0,1);
                    ss.setSoundParameter('endPosition', region.end/soundLength,0,1);
                    ss.setSoundParameter('loopStartPosition', region.start/soundLength,0,1);
                    ss.setSoundParameter('loopEndPosition', region.end/soundLength,0,1);
                    ss.playSound();

            })
            }

            $("#outer-box-launch > #inner-box-launch > p").text(newText);
            ss.setSoundParameterInt('launchMode', nextModeIndex);

            //Send Midi Msg
            sendMidiMessage();

        }

        function removeSoundFromList(){

            //Stop the sound first
            ss.stopSound(selectedSoundUUID);

            var sound = ss.getSoundFromSoundUUID(selectedSoundUUID);
            var samplerSounds = ss.getSoundSamplerSounds(sound);
            var samplerSound = samplerSounds[0];
            //Remove the sound from sound list
            $("select#sound-dropdown option").filter(":contains('" + samplerSound.getAttribute('name')+"')").remove();

            //Remove the sound from state
            ss.removeSound(selectedSoundUUID);

            
        }
        function updateSoundList(soundUUID){
            var sound = ss.getSoundFromSoundUUID(soundUUID);

            if (sound === null){
                // Sound can be null if triggering this method in a delayed way and sound does not longer exist
                return;
            }
            //Wait until the query is done
            var samplerSounds = ss.getSoundSamplerSounds(sound);
            var samplerSound = samplerSounds[0];
            //If sound exists and loaded, don't add id
                    $("div.sound-list select").append($('<option>')
                        .text(samplerSound.getAttribute('name'))
                        .data({
                            uuid: soundUUID,
                            sound: samplerSound.getAttribute('name'),
                        })
                        );
        }



        function updateFullUI(){
            // Set the main preset parameters to the values form the state
            updateMainPresetParameters();
            // Update all the section with individual sound cards
        }

        function updateVolatileUI(){
            // Update the audio meters and the voice allocation section
            // Also update other things like query status


            //Launch Mode Check
            checkBox = document.getElementById('loopfb');

            var VolatileState = ss.volatileState.getElementsByTagName('VOLATILE_STATE')[0];

            var isQuerying = VolatileState.getAttribute('isQuerying') != "0";
            var queryingIndicator = document.getElementById('query-indicator');
            if (isQuerying){
                queryingIndicator.classList.add('query-animation');
            } else {
                queryingIndicator.classList.remove('query-animation');
            }
            


            var voicesStateElement = document.getElementById('voicesState');
            var html = '<div class="voices">';
            if (VolatileState !== undefined){
                var voiceActivations = VolatileState.getAttribute('voiceActivations').split(',').slice(0, -1);
                var voiceSoundIdxs = VolatileState.getAttribute('voiceSoundIdxs').split(',').slice(0, -1);
                var voiceSoundPlayPosition = VolatileState.getAttribute('voiceSoundPlayPosition').split(',').slice(0, -1);

                for (var i=0; i<voiceSoundIdxs.length; i++){
                    if (voiceSoundIdxs[i] == "-1"){
                        // Draw empty square
                        html += '<div class="voice"><div class="voice_progress" style="width:0%;">&nbsp;</div></div>'
                    } else {
                        html += '<div class="voice"><div class="voice_progress" style="width:' + 100 * parseFloat(voiceSoundPlayPosition[i], 10) + '%;">' + ss.findSoundIdxFromSourceSamplerSoundUUID(voiceSoundIdxs[i]) + '</div></div>'
                    }
                }
            }
            html += "</div>";
            voicesStateElement.innerHTML = html;

            var metersStateElement = document.getElementById('metersState');
            var html = '<div class="meters">';
            if (VolatileState !== undefined){
                var audioLevels = VolatileState.getAttribute('audioLevels').split(',').slice(0, -1);
                for (var i=0; i<audioLevels.length; i++){
                    html += '<div class="channel_meter"><div class="channel_level" style="height:' + 100 * parseFloat(audioLevels[i], 10) + '%;"></div></div>'
                }
            }
            html += "</div>";
            metersStateElement.innerHTML = html;
        }

       function drawSoundWaveform(){
            var sound = ss.getSoundFromSoundUUID(selectedSoundUUID);
            var samplerSound = ss.getSoundSamplerSounds(sound);
            var sourceSamplerSoundUUID = samplerSound[0].getAttribute('uuid');

            const canvas = document.getElementById("waveform");
            if (canvas !== null){
                    if (httpPort !== undefined){
                        let url = 'http' + (useHttps ? 's':'') + '://' + hostname + ':' + httpPort + '/sounds_data/' + sourceSamplerSoundUUID + '.wav';
                        //let url = ss.getTmpFilesLocation() + '/' + sourceSamplerSoundUUID + '.wav'; // Not supported because of CORS...
                        console.log("Getting waveform for", url);

                        //Remove the previous sounds wave element
                        $('wave').remove();
                        wavesurfer = WaveSurfer.create({        
                                                    container: document.querySelector('#waveform'),
                                                    waveColor: wavesurferColor,
                                                    progressColor: 'aqua',
                                                    backend: 'MediaElement',
                                                    cursorWidth: 2,
                                                    responsive: 'true',
                                                    height: '100',
                                                    plugins: [ WaveSurfer.regions.create({})
                                                    ]

                                        });
                    wavesurfer.load(url);


                       

                    }
                }
            }



        function drawAdsrEnvelope(){

        var DefaultParamsMod = {
            attackTime: ss.getSoundParameterValue(selectedSoundUUID, 'filterAttack'),
            decayTime: ss.getSoundParameterValue(selectedSoundUUID, 'filterDecay'),
            sustainLevel: ss.getSoundParameterValue(selectedSoundUUID, 'filterSustain'),
            releaseTime: ss.getSoundParameterValue(selectedSoundUUID, 'filterRelease'),
            gateTime: 1,
            peakLevel: 1,
            epsilon: 0.001,
            attackCurve: "exp",
            decayCurve: "exp",
            releaseCurve: "exp",
            };

        var DefaultParamsAmp = {
            attackTime: ss.getSoundParameterValue(selectedSoundUUID, 'attack'),
            decayTime: ss.getSoundParameterValue(selectedSoundUUID, 'decay'),
            sustainLevel: ss.getSoundParameterValue(selectedSoundUUID, 'sustain'),
            releaseTime: ss.getSoundParameterValue(selectedSoundUUID, 'release'),
            gateTime: 1,
            peakLevel: 1,
            epsilon: 0.001,
            attackCurve: "exp",
            decayCurve: "exp",
            releaseCurve: "exp",
            };

            //If the page has just loaded, operate on default parameter values
            startTime = -1;

            var env = new ADSREnvelope(DefaultParamsMod);
            var ampEnv = new ADSREnvelope(DefaultParamsAmp);


            var canvas = document.getElementById("adsr-envelope");
            var context = canvas.getContext("2d");

            var contextAmp = canvas.getContext("2d");
            var x, i;

            duration = (((env.duration / 5)|0) + 1) * 5;

            context.fillStyle = adsrBackgroundColor;
            context.fillRect(0, 0, canvas.width, canvas.height);

            //Filter ADSR
            context.strokeStyle = "#000000";
            context.lineWidth = 0.01;

            for (i = 1; i < duration; i++) {
                x = (((i / duration) * canvas.width)|0) + 0.5;

                context.beginPath();
                context.moveTo(x, 0);
                context.lineTo(x, canvas.height);
                context.stroke();
            }

            //Amplitude ADSR
            contextAmp.strokeStyle = "rgb(80, 1, 80)";
            contextAmp.lineWidth = 0.1;

            for (i = 1; i < duration; i++) {
                x = (((i / duration) * canvas.width)|0) + 0.5;

                contextAmp.beginPath();
                contextAmp.moveTo(x, 0);
                contextAmp.lineTo(x, canvas.height);
                contextAmp.stroke();
            }

            //Draw two envelopes for modulation and amplitude
            drawByEnvelope(contextAmp, duration, ampEnv,1,"#5fb9b9a1", 'amp');
            drawByEnvelope(context, duration, env,1, "rgba(118, 20, 148, 0.7)", 'modulation');


            function drawByEnvelope(context, duration, env, lineWidth, strokeStyle, type) {
            var t, v, y, x;
            var i, imax;
            var canvas = document.getElementById("adsr-envelope");


            context.strokeStyle = strokeStyle;
            context.lineWidth = lineWidth;
            context.lineCap = "round";

            context.beginPath();
            for (i = 0, imax = canvas.width; i < imax; i++) {
                t = (i / imax) * duration;
                v = env.valueAt(t);
                y = canvas.height - (canvas.height * v);
                x = (i / imax) * canvas.width;

                context.lineTo(x, y);
            }
            context.stroke();

            }}

          


    </script>
</head>

<body>

    <div class="container">
        <div class="source-icon">
            SOURCE
            <div class="mode-button" value="0" onclick="switchColorModes(this);">
                <p>mode</p>
            </div>
        </div>
        <div class="query-parameters">
            <div class="query-search">
                <div class="query-text">
                <input name="query" value="" type="search" placeholder="piano" />
            </div>
                <div class="query-button"  onclick="ss.addSoundsByQuery()">
                    <div class="query-icon">
                    <svg id="query-indicator" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#d4d2d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                  </div>                
                </div>
            </div>
            <div id="q-par-labels">
                <p style="margin-left: 5px;">Number of sounds</p>
                <p style="margin-left: -5px;">Min/Max Sound Length</p>
                <p style="margin-left: 2px;">Note Layout Type</p>
            </div>
            <div id="q-par">
                    <div class="single-slider">
                    </div>
                    <div class="double-slider">
                    </div>
                <div class="slider-regular" onclick="changeNoteLayout();" id="noteLayout">
                    <p style="margin-top:3px;">contiguous</p>
                </div>
            </div>
        </div>
        <div class="waveform">
            <div id="waveform"></div>
            <div class="launch-mode">
                <div class="left-arrow">
                    <button class="left-arrow-inner" onclick="updateLaunchMode(this);"></button>
                </div>
                <div class="outer-box" id="outer-box-launch">
                    <div class="inner-box" id="inner-box-launch">
                        <p>gate</p>
                    </div>
                </div>
                <div class="right-arrow">
                    <button class="right-arrow-inner" onclick="updateLaunchMode(this);"></button>
                </div>
        </div>
        </div>
        <div class="adsr">
            <canvas id="adsr-envelope" style="background-color: transparent;"></canvas>
        </div>
        <div class="adsr-envelope-knobs">
            <div class="adsr-header">
                <div class="left-arrow">
                    <button class="left-arrow-inner" onclick="changeADSRElementId(this);"></button>
                </div>
                <div class="outer-box" id="outer-box-adsr">
                    <div class="inner-box" id="inner-box-launch">
                        <p>filter</p>
                    </div>
                </div>
                <div class="right-arrow">
                    <button class="right-arrow-inner" onclick="changeADSRElementId(this);"></button>
                </div>        
            </div>
            <div class="adsr-first-knob">
            <div class="knob-1" id="attack">
                <div class="knob-inner"></div>
                <p style="margin-left:7.5px;">attack</p>
            </div>
            <div class="knob-1" id="decay">
                <div class="knob-inner"></div>
                <p style="margin-left:7.5px;">decay</p>
            </div>
            <div class="knob-1" id="sustain">
                <div class="knob-inner"></div>
                <p style="margin-left:7px;">sustain</p>
            </div>
            <div class="knob-1" id="release">
                <div class="knob-inner"></div>
                <p style="margin-left:8px;">release</p>
            </div>
        </div>
        <div class="adsr-second-knob">
            <div class="knob-2000" id="filterCutoff">
                <div class="knob-inner"></div>
                <p style="margin-left:7.5px;">cutoff</p>
            </div>
            <div class="filterADSR2CutoffAmt">
            <div class="knob-100" id="filterADSR2CutoffAmt">
                <div class="knob-inner"></div>
                <p style="margin-left:8px;">cutoff amount</p>
            </div>
        </div>
            <div class="knob-1" id="filterRessonance">
                <div class="knob-inner"></div>
                <p style="margin-left:9px;">ressonance</p>
            </div>
        </div>

        </div>
        <div class="sound-list">
            <select multiple name="sounds" id="sound-dropdown" onclick="ss.playSound()" onchange="updateGlobalSoundUUID();" style="width:100%;height:100%;">
            </select>
            <div class="sound-list-options">
                <div class="sound-list-buttons"">
                    <div class="stop-icon" onclick="ss.stopSound('stop');"></div>
                </div>
                <div class="sound-list-buttons">
                    <div class="remove-icon" onclick="removeSoundFromList();"></div>
                </div>
                <div class="sound-list-buttons" id="reverse" value="0" onclick="updateReverseState(this);">
                </div>
            </div>
        </div>
        <div class="parameter-knobs">
            <div class="reverb-header">
                <p>Reverb</p>
            </div>
            <div class="reverb-knob-area">
                <div class="knob-reverb" id="roomSize">
                    <div class="knob-inner"></div>
                    <p style="margin-left:6.5px;">room</p>
                </div>
                <div class="knob-reverb" id="damping">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">damping</p>
                </div>
                <div class="knob-reverb" id="wetLevel">
                    <div class="knob-inner"></div>
                    <p style="margin-left:8px;">wet</p>
                </div>
                <div class="knob-reverb" id="dryLevel">
                    <div class="knob-inner"></div>
                    <p style="margin-left:8px;">dry</p>
                </div>
            </div>
            <div class="modulation-header">
                <p>Modulation</p>
            </div>
            <div class="modulation-knob-area">
                <div class="knob-12" id="mod2GainAmt">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">gain</p>
                </div>
                <div class="knob-100" id="mod2CutoffAmt">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7.5px;">cutoff</p>
                </div>
                <div class="knob-12" id="mod2PitchAmt">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7px;">pitch</p>
                </div>
            </div>
            <div class="velocity-header">
                <p>Velocity</p>   
            </div>
            <div class="velocity-knob-area">
                <div class="knob-100" id="vel2CutoffAmt">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7px;">cutoff</p>
                </div>
                <div class="knob-1" id="vel2GainAmt">
                    <div class="knob-inner"></div>
                    <p style="margin-left:7px;">gain</p>
                </div>
            </div>
        </div>
            <ul id="keyboard">
                <li note="C" id="60" class="white-key" onclick="sendMidiMessage(this);">
                <p>C3</p>
                </li>
                <li note="C#" id="61" class="black-key" onclick="sendMidiMessage(this);"></li>
                <li note="D" id="62" class="white-key offset" onclick="sendMidiMessage(this);"></li>
                <li note="D#" id="63" class="black-key" onclick="sendMidiMessage(this);"></li>
                <li note="E" id="64" class="white-key offset" onclick="sendMidiMessage(this);"></li>
                <li note="F" id="65" class="white-key" onclick="sendMidiMessage(this);"></li>
                <li note="F#" id="66" class="black-key" onclick="sendMidiMessage(this);"></li>
                <li note="G" id="67" class="white-key offset" onclick="sendMidiMessage(this);"></li>
                <li note="G#" id="68" class="black-key" onclick="sendMidiMessage(this);"></li>
                <li note="A" id="69" class="white-key offset" onclick="sendMidiMessage(this);"></li>
                <li note="A#" id="70" class="black-key" onclick="sendMidiMessage(this);"></li>
                <li note="B" id="71" class="white-key offset" onclick="sendMidiMessage(this);"></li>
                <li note="C2" id="72" class="white-key" onclick="sendMidiMessage(this);">
                <p>C4</p>
                </li>
                <li note="C#" id="73" class="black-key" onclick="sendMidiMessage(this);"></li>
                <li note="D" id="74" class="white-key offset" onclick="sendMidiMessage(this);"></li>
                <li note="D#" id="75" class="black-key" onclick="sendMidiMessage(this);"></li>
                <li note="E" id="76" class="white-key offset" onclick="sendMidiMessage(this);"></li>
                <li note="F" id="77" class="white-key" onclick="sendMidiMessage(this);"></li>
                <li note="F#" id="78" class="black-key" onclick="sendMidiMessage(this);"></li>
                <li note="G" id=79" class="white-key offset" onclick="sendMidiMessage(this);"></li>
                

            </ul>

            <div class="pitch-section">
                <input class="slider-regular-down" style="transform: rotate(-90deg);width: 90px;" id ="octave" type="range" name="octave" min="-2" max="7" value="3" step="1" oninput="updateOctave(this);">
                <p id='octave-text' style="margin-left:-75px;margin-top:140px;font-size:12px;">octave</p>
                <input class="slider-regular-down" style="transform: rotate(-90deg);width: 90px;" id ="pitch" type="range" name="pitch" min="-36.0" max="36.0" value="0.0" step="0.01" oninput="ss.setSoundParameter(this.name, this.value, this.min, this.max)">
                <p id='pitch-text' style="margin-left:-75px;margin-top:140px;font-size:12px;">pitch range</p>

            </div>

            <div class="controls_card controls_card_top" hidden>
                <h4>Preset & settings</h4>
                Preset number:</label><input name="presetIdx" value="" type="number">
                <button onclick="ss.savePreset()">Save</button>
                <button onclick="ss.loadPreset()">Load</button><br>
                Preset name:</label><input name="presetName" value="" type="text">
                <button onclick="ss.previousPreset()">&#x25C0</button><button onclick="ss.nextPreset()">&#x25b6</button><br>
                MIDI in channel:<input name="midiInChannel" value="" type="number" onchange="ss.setMidiInChannel()"><br>
                Num voices:<input name="numVoices" value="" type="number" onchange="ss.setNumVoices()"><br>
                <div id="voicesState"></div>
            </div>
            <div class="controls_card controls_card_top" hidden>
                <div id="metersState"></div>
            </div>

        </div>
    </div>
</body>
</html>
