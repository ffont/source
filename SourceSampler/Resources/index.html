<!DOCTYPE html>
<html>

<head>
    <title>Source, a Freesound-powered sampler</title>

    <style>
        .cards_container_slide {
            overflow: scroll;
            white-space: nowrap;
            vertical-align: top;
        }

        .controls_card {
            display:inline-block;
            padding:5px;
            background-color:#eeeeee;
            margin:5px;
            vertical-align: top;
        }
        
        .voice {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 1px solid black;
        }

        .voice_progress {
            overflow: hidden;
            background-color: greenyellow;
            height: 100%;
        }
    
        .channel_meter{
            display: inline-block;
            width: 30px;
            height: 80px;
            border: 1px solid black;
            position: relative;
        }
    
        .channel_level{
            width: 100%;
            overflow: hidden;
            background-color: greenyellow;
            position:absolute;
            bottom:0;
            left:0;
        }

        #voicesState{
            max-width: 260px;
        }

        #individualSoundEditors{
            display: inline-block;
            vertical-align: top;
        }

        #allSoundsEditor{
            display: inline-block;
            vertical-align: top;
        }
    </style>

    <script>

        var updateStateTimer;
        var updateSystemStatsTimer;
        var lastReceivedStateText;
        var lastReceivedStateXml;
        var updateStateInterval = 100;

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById('allSoundsEditor').innerHTML = '<b>All sounds</b><br>' + generateSoundEditControls(-1);
            updateAllSliderLabels();

            startAutoUpdate();
        });

        function startAutoUpdate(){
            updateStateTimer = setInterval(function () {
                updateState();
            }, updateStateInterval);

            updateSystemStatsTimer = setInterval(function () {
                getSystemStats();
            }, 1000);
        }

        function stopAutoUpdate() {
            window.clearInterval(updateStateTimer);
            window.clearInterval(updateSystemStatsTimer);
        }

        function updateAllSliderLabels(){
            var elements = document.querySelectorAll("input[type=range]")
            for (var i = 0, sliderElement; sliderElement = elements[i++];) {
                updateSliderLabel(sliderElement);
            }
        }

        function updateSliderLabel(sliderElement){
            var labelElement = document.getElementById(sliderElement.id + "Label");
            if (labelElement != null) {
                if (labelElement.id.indexOf("launchModeLabel") > -1){
                    labelElement.innerHTML = ["gate", "loop", "loopfb", "trigger", "freeze"][sliderElement.value];
                } else if (labelElement.id.indexOf("noteMappingMode") > -1){
                    labelElement.innerHTML = ["pitch", "slice", "both", "repeat"][sliderElement.value];
                } else if (labelElement.id.indexOf("numSlices") > -1){
                    var names =  ["auto (n notes)", "auto (onsets)"]
                    for (var i=2; i<=128; i++){
                        names.push(i);
                    }
                    labelElement.innerHTML = names[sliderElement.value];
                } else {
                    labelElement.innerHTML = getProcessedSoundParameterValuLinToExp(sliderElement).toFixed(2);
                }
            }
        }

        var expStrength = 2;

        function linToExp(x){
            return (Math.pow(x,expStrength));
        }

        function expToLin(x){
            return (Math.pow(x,1/expStrength));
        }

        function sliderShouldBehaveExponentially(sliderElement){
            var name = sliderElement.name;
            if (name != null){
                if ((name.indexOf("attack") > -1) ||
                    (name.indexOf("decay") > -1) ||
                    (name.indexOf("release") > -1) ||
                    (name == "filterCutoff")
                ){
                    return true;
                }
            }
            
            return false;
        }

        function getProcessedSoundParameterValuLinToExp(sliderElement){
            var value = parseFloat(sliderElement.value, 10);
            if (sliderShouldBehaveExponentially(sliderElement) == true){
                return linToExp(value/sliderElement.max)*sliderElement.max;
            } else {
                return value;
            }
        }

        function getProcessedSoundParameterValueExpToLin(sliderElement, valueRaw){
            if (sliderShouldBehaveExponentially(sliderElement) == true){
                return expToLin(valueRaw/sliderElement.max)*sliderElement.max;
            } else {
                return valueRaw;
            }
        }

        function sendOsc(address, values, types) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                }
            };
            xhr.open('GET', '/send_osc?address=' + address + '&values=' + values.join(';') + '&types=' + types, true);
            xhr.send();
        }

        function setSoundParameter(soundIdx, sliderElement){
            sliderElement.setAttribute("data-lastMoved", Date.now()/1000);
            updateSliderLabel(sliderElement);
            sendOsc('/set_sound_parameter', [soundIdx, sliderElement.name, getProcessedSoundParameterValuLinToExp(sliderElement)], 'int;str;float')
        }

        function setSoundParameterInt(soundIdx, sliderElement){
            sliderElement.setAttribute("data-lastMoved", Date.now()/1000);
            updateSliderLabel(sliderElement);
            sendOsc('/set_sound_parameter_int', [soundIdx, sliderElement.name, sliderElement.value], 'int;str;int')
        }

        function makeQuery(){
            var query = document.getElementsByName('query')[0].value;
            var numSounds = document.getElementsByName('numSounds')[0].value || 16;
            var maxSoundLength = document.getElementsByName('maxSoundLength')[0].value || 0.5;
            sendOsc('/new_query', [query, numSounds, maxSoundLength], 'str;int;float')
        }

        function setMidiInChannel() {
            var midiInChannel = document.getElementsByName('midiInChannel')[0].value;
            sendOsc('/set_midi_in_channel', [midiInChannel], 'int')
        }

        function setMidiThru() {
            var midiThru = document.getElementsByName('midiThru')[0].checked;
            sendOsc('/set_midi_thru', [midiThru ? 1: 0], 'int')
        }

        function setReverbParameters() {
            var roomSize = document.getElementById('0_roomSize').value;
            var damping = document.getElementById('0_damping').value;
            var wetLevel = document.getElementById('0_wetLevel').value;
            var dryLevel = document.getElementById('0_dryLevel').value;
            var width = document.getElementById('0_width').value;
            var freezeMode = document.getElementById('0_freezeMode').value;
            updateAllSliderLabels();
            sendOsc('/set_reverb_parameters', [roomSize, damping, wetLevel, dryLevel, width, freezeMode], 'float;float;float;float;float;float')
        }

        function setNumVoices() {
            var numVoices = document.getElementsByName('numVoices')[0].value;
            sendOsc('/set_polyphony', [numVoices], 'int')
        }

        function playSound(soundIdx){
            sendOsc('/play_sound', [soundIdx], 'int')
        }

        function stopSound(soundIdx){
            sendOsc('/stop_sound', [soundIdx], 'int')
        }

        function savePreset(){
            var name = document.getElementsByName('presetName')[0].value;
            var idx = document.getElementsByName('presetIdx')[0].value;
            sendOsc('/save_current_preset', [name, idx], 'str;int')
        }

        function loadPreset() {
            var idx = document.getElementsByName('presetIdx')[0].value;
            sendOsc('/load_preset', [idx], 'int')
        }

        function nextPreset(){
            var idx = document.getElementsByName('presetIdx')[0].value;
            if (idx == undefined){
                idx = -1;
            } else {
                idx = parseInt(idx, 10);
                if (isNaN(idx)){
                    idx = -1;
                }
            }
            sendOsc('/load_preset', [idx + 1], 'int')
        }

        function previousPreset(){
            var idx = document.getElementsByName('presetIdx')[0].value;
            if (idx == undefined){
                idx = 1;
            } else {
                idx = parseInt(idx, 10);

                if (isNaN(idx)){
                    idx = 1;
                }
            }
            if (idx < 1){
                idx = 1; //Will become 0 when subtracted 1
            }
            sendOsc('/load_preset', [idx - 1], 'int')
        }

        // UI generation
        function generateSoundEditControls(soundIdx){
            html = '';
            // --> Start auto-generated code A
            html += '<input type="range" id="' + soundIdx + '_filterCutoff" name="filterCutoff" min="10.0" max="20000.0" value="20000.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > filterCutoff: <span id="' + soundIdx + '_filterCutoffLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_filterRessonance" name="filterRessonance" min="0.0" max="1.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > filterRessonance: <span id="' + soundIdx + '_filterRessonanceLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_maxPitchRatioMod" name="maxPitchRatioMod" min="0.0" max="2.0" value="0.1" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > maxPitchRatioMod: <span id="' + soundIdx + '_maxPitchRatioModLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_maxFilterCutoffMod" name="maxFilterCutoffMod" min="0.0" max="100.0" value="10.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > maxFilterCutoffMod: <span id="' + soundIdx + '_maxFilterCutoffModLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_filterKeyboardTracking" name="filterKeyboardTracking" min="0.0" max="1.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > filterKeyboardTracking: <span id="' + soundIdx + '_filterKeyboardTrackingLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_gain" name="gain" min="-80.0" max="12.0" value="-10.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > gain: <span id="' + soundIdx + '_gainLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_ampADSR.attack" name="ampADSR.attack" min="0.0" max="20.0" value="0.01" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > ampADSR.attack: <span id="' + soundIdx + '_ampADSR.attackLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_ampADSR.decay" name="ampADSR.decay" min="0.0" max="20.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > ampADSR.decay: <span id="' + soundIdx + '_ampADSR.decayLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_ampADSR.sustain" name="ampADSR.sustain" min="0.0" max="1.0" value="1.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > ampADSR.sustain: <span id="' + soundIdx + '_ampADSR.sustainLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_ampADSR.release" name="ampADSR.release" min="0.0" max="20.0" value="1.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > ampADSR.release: <span id="' + soundIdx + '_ampADSR.releaseLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_filterADSR.attack" name="filterADSR.attack" min="0.0" max="20.0" value="0.01" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > filterADSR.attack: <span id="' + soundIdx + '_filterADSR.attackLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_filterADSR.decay" name="filterADSR.decay" min="0.0" max="20.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > filterADSR.decay: <span id="' + soundIdx + '_filterADSR.decayLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_filterADSR.sustain" name="filterADSR.sustain" min="0.0" max="1.0" value="1.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > filterADSR.sustain: <span id="' + soundIdx + '_filterADSR.sustainLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_filterADSR.release" name="filterADSR.release" min="0.0" max="20.0" value="1.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > filterADSR.release: <span id="' + soundIdx + '_filterADSR.releaseLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_maxFilterADSRMod" name="maxFilterADSRMod" min="0.0" max="10.0" value="1.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > maxFilterADSRMod: <span id="' + soundIdx + '_maxFilterADSRModLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_midiRootNote" name="midiRootNote" min="0" max="127" value="64" step="1" oninput="setSoundParameterInt(' + soundIdx + ', this)" > midiRootNote: <span id="' + soundIdx + '_midiRootNoteLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_basePitch" name="basePitch" min="-36.0" max="36.0" value="0.0" step="1.0" oninput="setSoundParameter(' + soundIdx + ', this)" > basePitch: <span id="' + soundIdx + '_basePitchLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_startPosition" name="startPosition" min="0.0" max="1.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > startPosition: <span id="' + soundIdx + '_startPositionLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_endPosition" name="endPosition" min="0.0" max="1.0" value="1.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > endPosition: <span id="' + soundIdx + '_endPositionLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_loopStartPosition" name="loopStartPosition" min="0.0" max="1.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > loopStartPosition: <span id="' + soundIdx + '_loopStartPositionLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_loopEndPosition" name="loopEndPosition" min="0.0" max="1.0" value="1.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > loopEndPosition: <span id="' + soundIdx + '_loopEndPositionLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_loopXFadeNSamples" name="loopXFadeNSamples" min="10" max="100000" value="500" step="1" oninput="setSoundParameterInt(' + soundIdx + ', this)" > loopXFadeNSamples: <span id="' + soundIdx + '_loopXFadeNSamplesLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_launchMode" name="launchMode" min="0" max="4" value="0" step="1" oninput="setSoundParameterInt(' + soundIdx + ', this)" > launchMode: <span id="' + soundIdx + '_launchModeLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_reverse" name="reverse" min="0" max="1" value="0" step="1" oninput="setSoundParameterInt(' + soundIdx + ', this)" > reverse: <span id="' + soundIdx + '_reverseLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_maxGainVelMod" name="maxGainVelMod" min="0.0" max="1.0" value="0.5" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > maxGainVelMod: <span id="' + soundIdx + '_maxGainVelModLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_vel2CutoffAmt" name="vel2CutoffAmt" min="0.0" max="10.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > vel2CutoffAmt: <span id="' + soundIdx + '_vel2CutoffAmtLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_at2GainAmt" name="at2GainAmt" min="0.0" max="1.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > at2GainAmt: <span id="' + soundIdx + '_at2GainAmtLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_pan" name="pan" min="-1.0" max="1.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > pan: <span id="' + soundIdx + '_panLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_pitchBendRangeUp" name="pitchBendRangeUp" min="0.0" max="36.0" value="12.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > pitchBendRangeUp: <span id="' + soundIdx + '_pitchBendRangeUpLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_pitchBendRangeDown" name="pitchBendRangeDown" min="0.0" max="36.0" value="12.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > pitchBendRangeDown: <span id="' + soundIdx + '_pitchBendRangeDownLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_noteMappingMode" name="noteMappingMode" min="0" max="3" value="0" step="1" oninput="setSoundParameterInt(' + soundIdx + ', this)" > noteMappingMode: <span id="' + soundIdx + '_noteMappingModeLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_numSlices" name="numSlices" min="0" max="128" value="0" step="1" oninput="setSoundParameterInt(' + soundIdx + ', this)" > numSlices: <span id="' + soundIdx + '_numSlicesLabel"></span><br>'
            html += '<input type="range" id="' + soundIdx + '_playheadPosition" name="playheadPosition" min="0.0" max="1.0" value="0.0" step="0.01" oninput="setSoundParameter(' + soundIdx + ', this)" > playheadPosition: <span id="' + soundIdx + '_playheadPositionLabel"></span><br>'
            // --> End auto-generated code A
            return html;
        }

        function updateElementValueFromXmlStates(element, attrName, newState, oldState){
            if (oldState !== undefined){
                if (oldState.getAttribute(attrName) != newState.getAttribute(attrName)){
                    element.value = newState.getAttribute(attrName);
                }
            } else {
                element.value = newState.getAttribute(attrName);
            }
        }

        function createCardForSound(idx, sound){ //sound = xml element
            var cardElementId = idx + "_" + sound.getAttribute('soundId');
            html = '<div class="controls_card" id="' + cardElementId + '">';
            html += '<div id="soundCardInfo_' + idx + '"></div>';
            html += '<div id="soundCardControls_' + idx +'" style="display:none;">' + generateSoundEditControls(idx) + '</div>';
            html += '</div>';
            return html;
        }
    
        function updateCardForSound(idx, sound){ //sound = xml element
            var soundInfoElement = document.getElementById('soundCardInfo_' + idx);
            var downloadProgress = sound.getAttribute('downloadProgress');
            if (downloadProgress != 100){
                // Sound not yet loaded, show download progress
                html = '<b>' + idx + " - " + sound.getAttribute('soundId') + '</b><br>';
                if (downloadProgress == null){
                    downloadProgress = 0;
                }
                html += 'Downloading: ' + downloadProgress + '%';
                soundInfoElement.innerHTML = html;
                
            } else {
                // Sound already loaded, show all info (if it has not been already shown)
                if (soundInfoElement.innerHTML.indexOf('playSound') == -1){
                    html = '<b>' + idx + " - " + sound.getAttribute('soundId') + '</b><button onclick="playSound(' + idx + ')">play</button><button onclick="stopSound(' + idx + ')">stop</button><br>';
                    html += sound.getAttribute('soundName') + '<br>';
                    var licenseURL = sound.getAttribute('soundLicense');
                    var licenseName = "-";
                    if ( licenseURL.indexOf('/by/') > -1) {licenseName = 'CC-BY'}
                    else if ( licenseURL.indexOf('/sampling+/') > -1) {licenseName = 'S+'}
                    else if ( licenseURL.indexOf('/by-nc/') > -1) {licenseName = 'CC-BY-NC'}
                    else if ( licenseURL.indexOf('/zero/') > -1) {licenseName = 'CC0'}
                    html += parseFloat(sound.getAttribute('soundDurationInSeconds'), 10).toFixed(2) + 's | ' + licenseName + '<br>';
                    soundInfoElement.innerHTML = html;
                }
                
                var soundControlsElement = document.getElementById('soundCardControls_' + idx);
                if (soundControlsElement.style.display === "none") {
                    soundControlsElement.style.display = "block";
                }
            }
        }

        function syncUIWithState(xmlState){
            
            var port = xmlState.getElementsByTagName('SourceFullState')[0].getAttribute('currentPort');
            if (document.getElementById("portIndicator").innerHTML != '(' + port + ')'){
                document.getElementById("portIndicator").innerHTML = '(' + port + ')';
            }
            
            var logMessages = xmlState.getElementsByTagName('SourceFullState')[0].getAttribute('logMessages').split(';');
            document.getElementById("log").innerHTML = '';
            for (var i=0; i<logMessages.length; i++){
                document.getElementById("log").innerHTML += logMessages[i] + '<br>';
            }
            
            var SourcePresetState = xmlState.getElementsByTagName('SourcePresetState')[0];
            var GlobalSettings = xmlState.getElementsByTagName('GlobalSettings')[0];
            var SamplerState = xmlState.getElementsByTagName('Sampler')[0];
            var OldStateSourcePresetState, OldStateGlobalSettings, OldStateSamplerState, OldStateReverbParameters = undefined; 
            var ReverbParameters = xmlState.getElementsByTagName('ReverbParameters')[0];
            if (lastReceivedStateXml !== undefined){
                OldStateSourcePresetState = lastReceivedStateXml.getElementsByTagName('SourcePresetState')[0];
                OldStateGlobalSettings = lastReceivedStateXml.getElementsByTagName('GlobalSettings')[0];
                OldStateSamplerState = lastReceivedStateXml.getElementsByTagName('Sampler')[0];
                OldStateReverbParameters = lastReceivedStateXml.getElementsByTagName('ReverbParameters')[0];
            }
            
            // Update main preset settings and global settings (only update if state has changed)
            updateElementValueFromXmlStates(document.getElementsByName('query')[0], 'query', SourcePresetState, OldStateSourcePresetState);
            updateElementValueFromXmlStates(document.getElementsByName('presetIdx')[0], 'presetNumber', SourcePresetState, OldStateSourcePresetState);
            updateElementValueFromXmlStates(document.getElementsByName('presetName')[0], 'presetName', SourcePresetState, OldStateSourcePresetState);
            updateElementValueFromXmlStates(document.getElementsByName('midiThru')[0], 'midiThru', GlobalSettings, OldStateGlobalSettings);
            updateElementValueFromXmlStates(document.getElementsByName('midiInChannel')[0], 'midiInChannel', GlobalSettings, OldStateGlobalSettings);
            updateElementValueFromXmlStates(document.getElementsByName('numVoices')[0], 'NumVoices', SamplerState, OldStateSamplerState);
            updateElementValueFromXmlStates(document.getElementById('0_roomSize'), 'reverb_roomSize', ReverbParameters, OldStateReverbParameters);
            updateElementValueFromXmlStates(document.getElementById('0_damping'), 'reverb_damping', ReverbParameters, OldStateReverbParameters);
            updateElementValueFromXmlStates(document.getElementById('0_wetLevel'), 'reverb_wetLevel', ReverbParameters, OldStateReverbParameters);
            updateElementValueFromXmlStates(document.getElementById('0_dryLevel'), 'reverb_dryLevel', ReverbParameters, OldStateReverbParameters);
            updateElementValueFromXmlStates(document.getElementById('0_width'), 'reverb_width', ReverbParameters, OldStateReverbParameters);
            updateElementValueFromXmlStates(document.getElementById('0_freezeMode'), 'reverb_freezeMode', ReverbParameters, OldStateReverbParameters);
            
            // Update volatile state
            var VolatileState = xmlState.getElementsByTagName('VolatileState')[0];

            var voicesStateElement = document.getElementById('voicesState');
            var html = '<div class="voices">';
            if (VolatileState !== undefined){
                var voiceActivations = VolatileState.getAttribute('voiceActivations').split(',').slice(0, -1);
                var voiceSoundIdxs = VolatileState.getAttribute('voiceSoundIdxs').split(',').slice(0, -1);
                var voiceSoundPlayPosition = VolatileState.getAttribute('voiceSoundPlayPosition').split(',').slice(0, -1);
                
                for (var i=0; i<voiceSoundIdxs.length; i++){
                    if (voiceSoundIdxs[i] == "-1"){
                        // Draw empty square
                        html += '<div class="voice"><div class="voice_progress" style="width:0%;">&nbsp;</div></div>'
                    } else {
                        html += '<div class="voice"><div class="voice_progress" style="width:' + 100 * parseFloat(voiceSoundPlayPosition[i], 10) + '%;">' + voiceSoundIdxs[i] + '</div></div>'
                    }
                }
            }
            html += "</div>";
            voicesStateElement.innerHTML = html;
            
            var metersStateElement = document.getElementById('metersState');
            var html = '<div class="meters">';
            if (VolatileState !== undefined){
                var audioLevels = VolatileState.getAttribute('audioLevels').split(',').slice(0, -1);
                for (var i=0; i<audioLevels.length; i++){
                    html += '<div class="channel_meter"><div class="channel_level" style="height:' + 100 * parseFloat(audioLevels[i], 10) + '%;"></div></div>'
                }
            }
            html += "</div>";
            metersStateElement.innerHTML = html;
 
            // Update individual sound editors

            // Check if the sound listing has changed
            var shouldRedoCards = false;
            var soundInfoElements = xmlState.getElementsByTagName('soundInfo');
            var OldStateSoundInfoElements = undefined;

            if (lastReceivedStateXml === undefined){
                shouldRedoCards = true;
            } else {
                OldStateSoundInfoElements = lastReceivedStateXml.getElementsByTagName('soundInfo');
                
                var newStateIds = "";
                var oldStateIds = "";
                for (var i=0; i<soundInfoElements.length; i++){
                    newStateIds += soundInfoElements[i].getAttribute('soundId') + ',';
                }
                for (var i=0; i<OldStateSoundInfoElements.length; i++){
                    oldStateIds += OldStateSoundInfoElements[i].getAttribute('soundId') + ',';
                }
                if (newStateIds != oldStateIds){
                    shouldRedoCards = true;
                }
            }

            // Re-create sound cards if needed
            if (shouldRedoCards){
                var individualSoundEditorsElement = document.getElementById('individualSoundEditors');
                individualSoundEditorsElement.innerHTML = '';
                for (var i = 0; i < soundInfoElements.length; i++) {
                    var sound = soundInfoElements[i];
                    var soundCardHtml = createCardForSound(i, sound);
                    individualSoundEditorsElement.innerHTML += soundCardHtml;
                }
            }

            // Update sound sliders if slider was not moved recently
            var slidersToUpdate = [];
            for (var i = 0; i < soundInfoElements.length; i++) {
                var sound = soundInfoElements[i];
                updateCardForSound(i, sound); // Update basic card details
                
                var samplerSound = sound.getElementsByTagName('SamplerSound')[0];
                var soundIdx = samplerSound.getAttribute('soundIdx');
                var samplerSoundParameters = samplerSound.getElementsByTagName('SamplerSoundParameter');
                for (var j = 0; j < samplerSoundParameters.length; j++) {
                    var parameter = samplerSoundParameters[j];
                    var name = parameter.getAttribute('parameter_name');
                    var type = parameter.getAttribute('parameter_type');
                    var rawValue = parameter.getAttribute('parameter_value');
                    if (type == "float"){
                        var sliderElement = document.getElementById(i + '_' + name) // Needed to get slider max value
                        var value = getProcessedSoundParameterValueExpToLin(sliderElement, parseFloat(rawValue, 10));
                        slidersToUpdate.push([i + '_' + name, value])
                    } else if (type == "int"){
                        slidersToUpdate.push([i + '_' + name, parseInt(rawValue, 10)])
                    }
                }
            }
            for (var i=0; i<slidersToUpdate.length; i++){
                var sliderElement = document.getElementById(slidersToUpdate[i][0]);
                if (sliderElement !== undefined){
                    var sliderLastMoved = sliderElement.getAttribute("data-lastMoved");
                    if ((sliderLastMoved === undefined) || ((Date.now()/1000 - sliderLastMoved) > 0.25)){
                        // Only update sliders if they are being moved in the last 1 sec
                        sliderElement.value = slidersToUpdate[i][1];
                    }
                }
            }
            updateAllSliderLabels();
        }

        // State handling
        function updateState(){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                    if (this.responseText == 'Maybe old'){
                        document.getElementById("errorIndicator").innerHTML = 'Plugin appears to be offline';
                    } else {
                            document.getElementById("errorIndicator").innerHTML = 'Plugin appears to be offline';
                        if (this.responseXML != undefined){
                            document.getElementById("errorIndicator").innerHTML = '';
                            document.getElementById("state").value = this.responseText;
                            syncUIWithState(this.responseXML);
                            lastReceivedStateText = this.responseText;
                            lastReceivedStateXml = this.responseXML;
                        }
                    }
                } else {
                    document.getElementById("errorIndicator").innerHTML = 'Server appears to be offline';
                    document.getElementById("state").value = '';
                }
            };
            xhr.open('GET', '/update_state', true);
            xhr.send();
        }

        function getSystemStats(){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                    document.getElementById("systemStats").value = this.responseText;
                }
            };
            xhr.open('GET', '/get_system_stats', true);
            xhr.send();
        }
        
    </script>
</head>

<body>
    <h1>Source, a Freesound-powered sampler <span id="portIndicator"></span></h1>
    <span id="errorIndicator"></span><br>

    <div class="controls_card">
        <b>Preset</b><br>
        Preset number:</label><input name="presetIdx" value="" type="number">
        <button onclick="savePreset()">Save</button>
        <button onclick="loadPreset()">Load</button><br>
        Preset name:</label><input name="presetName" value="" type="text">
        <button onclick="previousPreset()"><<</button><button onclick="nextPreset()">>></button>
    </div>

    <div class="controls_card">
        <b>Query</b><br>
        Query:<input name="query" value="" type="text" placeholder="percussion"><br>
        Num sounds:<input name="numSounds" value="" type="text" placeholder="16"><br>
        Max sound length:<input name="maxSoundLength" value="" type="text" placeholder="0.5"><br>
        <button onclick="makeQuery()">Go!</button>
    </div>

    <div class="controls_card">
        <b>Reverb</b><br>
        <input type="range" id="0_roomSize" name="roomSize" min="0.0" max="1.0" value="0.5" step="0.01" oninput="setReverbParameters()">
        roomSize: <span id="0_roomSizeLabel"></span><br>
        <input type="range" id="0_damping" name="damping" min="0.0" max="1.0" value="0.5" step="0.01" oninput="setReverbParameters()">
        damping: <span id="0_dampingLabel"></span><br>
        <input type="range" id="0_wetLevel" name="wetLevel" min="0.0" max="1.0" value="0.0" step="0.01" oninput="setReverbParameters()">
        wetLevel: <span id="0_wetLevelLabel"></span><br>
        <input type="range" id="0_dryLevel" name="dryLevel" min="0.0" max="1.0" value="1.0" step="0.01" oninput="setReverbParameters()">
        dryLevel: <span id="0_dryLevelLabel"></span><br>
        <input type="range" id="0_width" name="width" min="0.0" max="1.0" value="1.0" step="0.01" oninput="setReverbParameters()">
        width: <span id="0_widthLabel"></span><br>
        <input type="range" id="0_freezeMode" name="freezeMode" min="0.0" max="1.0" value="0.0" step="0.01" oninput="setReverbParameters()">
        freezeMode: <span id="0_freezeModeLabel"></span>
    </div>

    <div class="controls_card">
        <b>System stats</b><br>
        <button onclick="getSystemStats();">Get system stats</button>
        <textarea id="systemStats" style="width:100%;height:100px;"></textarea>
    </div>

    <div class="controls_card">
        <b>Global options</b><br>
        Num voices:<input name="numVoices" value="" type="number" onchange="setNumVoices()"><br>
        MIDI in channel:<input name="midiInChannel" value="" type="number" onchange="setMidiInChannel()"><br>
        MIDI thru:<input name="midiThru" value="" type="checkbox" onchange="setMidiThru()"><br>
    </div>

    <div class="controls_card">
        <b>Voices</b><br>
        <div id="voicesState"></div>
    </div>
    
    <div class="controls_card">
        <b>Meters</b><br>
        <div id="metersState"></div>
    </div>
    
    <div class="cards_container_slide">
        <div id="allSoundsEditor" style="background-color: honeydew;"></div>
        <div id="individualSoundEditors"></div>
    </div>

    <h3>State</h3>
    <button onclick="startAutoUpdate();">Start auto update</button><button onclick="stopAutoUpdate();">Stop auto update</button>
    <textarea id="state" style="width:100%;height:500px;"></textarea>
    
    <div class="controls_card">
        <b>Log</b><br>
        <div id="log"></div>
    </div>

</body>
</html>
