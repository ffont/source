<!DOCTYPE html>
<html>

<head>
    <title>Source, a Freesound-powered sampler</title>
    <meta name="viewport" content="width=300, user-scalable=no">
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.timeline.min.js"></script>

    <style>
        body {
            font-family: futura-pt,Avenir,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,Arial,sans-serif;
            font-size: 120%;
            background-color: black;
            color: white;
        }

        h2 {
            font-size: 1.3em;
            margin-block-end: 0.33em;
        }

        #wrapper {
            padding: 5px;
            width: 290px;
        }
        
        #waveformWrapper {
            margin-bottom: 10px;
        }

        .sliderWrapper {
            background-color:rgb(37, 37, 37);
            display:inline-block;
            border-radius: 4px;
            border: 0px;
            padding: 2px;
        }
    
        input {
            font-size: 120%;
            background-color: rgb(150, 150, 150);
            border-radius: 4px;
            border: 0px;
            padding: 2px;
        }

        ::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
            color: rgb(112, 112, 112);
            opacity: 1; /* Firefox */
        }

        input[type=number] {
            max-width: 80px;
        }

        button {
            margin-top: 8px;
            font-size: 120%;
            background-color: rgb(37, 37, 37);
            border-radius: 4px;
            border: 0px;
            padding: 6px;
            color:white;
        }

        button:active {
            background-color: rgb(110, 110, 110);
        }

        select {
            font-size: 120%;
            width: 180px;
        }
    
        .controls_card {
            vertical-align: top;
            margin-bottom: 40px;
            display: none;
        }

    </style>

    <script>

        var updateStateTimer;
        var updateStateInterval = 500;
        var currentlyInDefault = true;
        var wavesurfer;
        var regionLength = 0.05;

        function init() {
            showDefault();
            updateStateTimer = setInterval(function () {
                updateMinimalInterfaceState();
            }, updateStateInterval);

            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                plugins: [
                    WaveSurfer.regions.create({}),
                    WaveSurfer.timeline.create({
                        container: '#wave-timeline',
                        primaryColor: 'white',
                        secondaryColor: 'white',
                        primaryFontColor: 'white',
                        secondaryFontColor: 'white',
                        timeInterval: 1.0,
                        primaryLabelInterval: 1,
                        primaryLabelInterval: 0.5,    
                    })
                ],
                minPxPerSec: 50,
                scrollParent: true,
                waveColor: 'gray',
                progressColor: 'gray',
                cursorColor: 'gray',
                cursorWidth: 1,
                normalize: true,
            });

            wavesurfer.on('region-dblclick', function(region, event){  
                if (region.id.startsWith("slice")){
                    region.remove();
                }
            });
  

            document.querySelector('#zoom_slider').value = wavesurfer.params.pixelRatio;
            document.querySelector('#zoom_slider').oninput = function () {
                wavesurfer.zoom(Number(this.value));
            };
        }

        function updateMinimalInterfaceState(){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                    var response = JSON.parse(this.response);
                    if (response.should_ask_for_data){
                        currentlyInDefault = false;
                        showById(response.web_form_id, response.web_form_data);
                    } else {
                        if (!currentlyInDefault){
                            showDefault();
                        }
                    }
                    if (response.should_load_url){
                        window.location.href = response.should_load_url;
                    }
                }
            };
            xhr.open('GET', '/update_minimal_interface_state', true);
            xhr.send();
        }

        function setAllClassElementsDisplayTo(className, displayType){
            var all = document.getElementsByClassName(className);
            for (var i = 0; i < all.length; i++) {
                all[i].style.display = displayType; 
            }
        }

        function showDefault() {
            if (wavesurfer !== undefined){
                wavesurfer.empty();
                wavesurfer.clearRegions();
            }
            setAllClassElementsDisplayTo("controls_card", "none");
            setAllClassElementsDisplayTo("show_as_default", "block");
        }

        function hideDefault() {
            setAllClassElementsDisplayTo("show_as_default", "none");
        }       

        function showById(elementID, data){
            if (document.getElementById(elementID).style.display != "block"){
                hideDefault();
                document.getElementById(elementID).style.display = "block";

                if (elementID == "soundEditor"){
                    initSoundEditor(data);
                }
            }
        }

        function sendOsc(address, values, types) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                }
            };
            xhr.open('GET', '/send_osc?address=' + address + '&values=' + values.join(';') + '&types=' + types, true);
            xhr.send();
        }

        function sendDataToServer(data) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                }
            };
            xhr.open('GET', '/receive_data_from_web?data=' + data);
            xhr.send();
        }

        function makeQuery(){
            var element = document.getElementById('newQuery');
            var query = element.querySelector("input[name='query']").value;
            var numSounds = element.querySelector("input[name='numSounds']").value || 16;
            var minSoundLength = element.querySelector("input[name='minSoundLength']").value || 0.0;
            var maxSoundLength = element.querySelector("input[name='maxSoundLength']").value || 300;
            var noteMappingType = element.querySelector("select[name='noteMappingType']").value;
            sendOsc('/new_query', [query, numSounds, minSoundLength, maxSoundLength, noteMappingType], 'str;int;float;float;int');
        }

        function savePreset(){
            var element = document.getElementById('savePreset');
            var name = element.querySelector("input[name='presetName']").value;
            var idx = element.querySelector("input[name='presetIdx']").value;
            sendOsc('/save_current_preset', [name, idx], 'str;int');
        }

        function loadPreset() {
            var element = document.getElementById('loadPreset');
            var idx = element.querySelector("input[name='presetIdx']").value;
            sendOsc('/load_preset', [idx], 'int')
        }

        function isNumeric(str) {
            // https://stackoverflow.com/questions/175739/built-in-way-in-javascript-to-check-if-a-string-is-a-valid-number
            if (typeof str != "string") return false // we only process strings!  
            return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
                    !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
        }

        function makeReplaceSoundQuery(){
            var element = document.getElementById('replaceSound');
            var query = element.querySelector("input[name='query']").value;
            var minSoundLength = element.querySelector("input[name='minSoundLength']").value || 0.0;
            var maxSoundLength = element.querySelector("input[name='maxSoundLength']").value || 0.5;
            var data = 'query:' + query;
            if (!isNumeric(query)){
                data += ',minSoundLength:' + minSoundLength + ',maxSoundLength:' + maxSoundLength;
            } else {
                // if query is numeric only, don'y apply length filter because user is indicating sound id, but limit results to 1 so we don't radomply pick another result
                data += ',pageSize:1'

            }
            sendDataToServer(data);
            showDefault();
        }

        function initSoundEditor(data){
            document.getElementById("precision_editor_sound_id").innerHTML = data.soundID;
            wavesurfer.load(data.soundOGGURL.replace('ogg', 'mp3')); // Use MP3 instead so it can be loaded in Safari as well...
            //wavesurfer.load('/serve_sound/?path=' + data.soundPath);

            wavesurfer.on('ready', function(){
                wavesurfer.clearRegions();

                var duration = wavesurfer.getDuration();
                regionLength = duration/500;

                // Add start/end positions wavesurfer regions
                var startPosition = data.startPosition * duration;
                var endPosition = data.endPosition * duration;
                var startLoopPosition = data.loopStartPosition * duration;
                var endLoopPosition = data.loopEndPosition * duration;

                var regions = [
                    {
                        id: "startPosition",
                        start: startPosition,
                        end: startPosition + regionLength,
                        color: 'rgba(171, 255, 43, 0.8)',
                        resize: false
                    },
                    {
                        id: "endPosition",
                        start: endPosition - regionLength,
                        end: endPosition,
                        color: 'rgba(171, 255, 43, 0.8)',
                        resize: false
                    },
                    {
                        id: "loopStartPosition",
                        start: startLoopPosition,
                        end: startLoopPosition + regionLength,
                        color: 'rgba(255, 43, 43, 0.8)',
                        resize: false
                    },
                    {
                        id: "loopEndPosition",
                        start: endLoopPosition - regionLength,
                        end: endLoopPosition,
                        color: 'rgba(255, 43, 43, 0.8)',
                        resize: false
                    }
                ]
                for (i in regions){
                    wavesurfer.addRegion(regions[i]);
                }

                var slices = data.slices;
                for (i in slices){
                    addSlice(slices[i]);
                }
            })            
        }

        function addSlice(time){
            if (time === undefined){
                time = wavesurfer.getCurrentTime();
            }
            wavesurfer.addRegion({
                id: "slice_" + (Object.keys(wavesurfer.regions.list).length - 4),
                start: parseFloat(time, 10),
                end: parseFloat(time, 10) + regionLength,
                color: 'rgba(255, 255, 0, 0.8)',
                resize: false
            })
        }

        function clearSlices(time){
            var keys = Object.keys(wavesurfer.regions.list);
            for (i in keys){
                var key = keys[i];
                if (key.startsWith("slice_")){
                    wavesurfer.regions.list[key].remove();
                }
            }
        }

        function getPrecisionEditorMarkers(){
            var markers = [];
            var keys = Object.keys(wavesurfer.regions.list);
            for (i in keys){
                var key = keys[i];
                markers.push([wavesurfer.regions.list[key].id, wavesurfer.regions.list[key].start]);
            }
            return markers;
        }

        function sendPrecisionEditorParams(){
            data = "duration:" + wavesurfer.getDuration();
            var markers = getPrecisionEditorMarkers();
            for (i in markers){
                var marker = markers[i];
                data += "," + marker[0] + ":" + marker[1];
            }
            sendDataToServer(data);
            showDefault();
        }
        
    </script>
</head>

<body onload="init();">

    <div id="wrapper">
        <h1>SOURCE</h1>

        <div id="newQuery" class="controls_card show_as_default">
            <h2>Make new preset</h2>
            Query:<input name="query" value="" type="text" placeholder="percussion"><br>
            Num sounds:<input name="numSounds" value="" type="number" placeholder="16"><br>
            Sound length:<br><input name="minSoundLength" value="" type="number" placeholder="0.0"> to <input name="maxSoundLength" value="" type="number" placeholder="0.5"><br>
            Note mapping type: <select name="noteMappingType">
                <option value="0">contiguous</option>
                <option value="1">interleaved</option>
            </select>
            <br>
            <button onclick="makeQuery()">Go!</button>
        </div>

        <div id="replaceSound" class="controls_card">
            <h2>Replace sound with new query</h2>
            Query:<input name="query" value="" type="text" placeholder="percussion"><br>
            Sound length:<br><input name="minSoundLength" value="" type="number" placeholder="0.0"> to <input name="maxSoundLength" value="" type="number" placeholder="0.5"><br>
            <br>
            <button onclick="makeReplaceSoundQuery()">Go!</button>
        </div>

        <div id="soundEditor" class="controls_card">
            <h2>Precision editor sound <span id="precision_editor_sound_id"></span></h2>
            <div id="waveformWrapper">
                <div id="waveform"></div>
                <div id="wave-timeline"></div>
            </div>
            Zoom: 
            <div class="sliderWrapper">
                <input id="zoom_slider" type="range" min="20" max="3000" value="0">
            </div>
            <br>
            <button onclick="addSlice()">+ slice</button>
            <button onclick="clearSlices()">clear slices</button>
            <br>
            <button onclick="sendPrecisionEditorParams()">Ok</button>
        </div>

        <div id="savePreset" class="controls_card show_as_default">
            <h2>Save preset</h2>
            Preset number:<input name="presetIdx" value="" type="number"><br>
            Preset name:<br><input name="presetName" value="" type="text">
            <br>
            <button onclick="savePreset()">Save</button>
        </div>

        <div id="loadPreset" class="controls_card show_as_default">
            <h2>Load preset</h2>
            Preset number:<input name="presetIdx" value="" type="number">
            <br>
            <button onclick="loadPreset()">Load</button>
        </div>

        <br>
        <br>
        by Rita & Aurora
    </div>
    
</body>
</html>
