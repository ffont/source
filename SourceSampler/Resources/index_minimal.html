<!DOCTYPE html>
<html>

<head>
    <title>Source, a Freesound-powered sampler</title>
    <meta name="viewport" content="width=300, user-scalable=no">

    <style>
        body {
            font-family: futura-pt,Avenir,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,Arial,sans-serif;
            font-size: 120%;
            background-color: black;
            color: white;
        }

        h2 {
            font-size: 1.3em;
            margin-block-end: 0.33em;
        }

        #wrapper {
            padding: 5px;
            width: 290px;
        }

        #workingIndicator {
            background-color:rgb(37, 37, 37);
            position: fixed;
            width: 200px;
            margin: auto;
            text-align: center;
            padding: 30px;
            border-radius: 4px;
            z-index: 9;
            top: 150px;
            left: 25px;
        }

        .sliderWrapper {
            background-color:rgb(37, 37, 37);
            display:inline-block;
            border-radius: 4px;
            border: 0px;
            padding: 2px;
        }
    
        input {
            font-size: 120%;
            background-color: rgb(150, 150, 150);
            border-radius: 4px;
            border: 0px;
            padding: 2px;
        }

        ::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
            color: rgb(112, 112, 112);
            opacity: 1; /* Firefox */
        }

        input[type=number] {
            max-width: 80px;
        }

        button {
            margin-top: 8px;
            font-size: 120%;
            background-color: rgb(37, 37, 37);
            border-radius: 4px;
            border: 0px;
            padding: 6px;
            color:white;
        }

        button:active {
            background-color: rgb(110, 110, 110);
        }

        select {
            font-size: 120%;
            width: 180px;
        }
    
        .controls_card {
            vertical-align: top;
            margin-bottom: 40px;
            display: none;
        }

    </style>

    <script>

        var updateStateTimer;
        var updateStateInterval = 500;
        var currentlyInDefault = true;
        var wavesurfer;
        var regionLength = 0.05;

        function init() {
            showDefault();
            updateStateTimer = setInterval(function () {
                updateMinimalInterfaceState();
            }, updateStateInterval);
        }

        function showWorkingLabel(){
            document.getElementById("workingIndicator").style.display = "block";
        }

        function updateMinimalInterfaceState(){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                    var response = JSON.parse(this.response);
                    if (response.should_ask_for_data){
                        currentlyInDefault = false;
                        showById(response.web_form_id, response.web_form_data);
                    } else {
                        if (!currentlyInDefault){
                            showDefault();
                        }
                    }
                    if (response.should_load_url){
                        window.location.href = response.should_load_url;
                    }
                }
            };
            xhr.open('GET', '/update_minimal_interface_state', true);
            xhr.send();
        }

        function setAllClassElementsDisplayTo(className, displayType){
            var all = document.getElementsByClassName(className);
            for (var i = 0; i < all.length; i++) {
                all[i].style.display = displayType; 
            }
        }

        function showDefault() {
            document.getElementById("workingIndicator").style.display = "none";
            if (wavesurfer !== undefined){
                wavesurfer.empty();
                wavesurfer.clearRegions();
            }
            setAllClassElementsDisplayTo("controls_card", "none");
            setAllClassElementsDisplayTo("show_as_default", "block");
        }

        function hideDefault() {
            setAllClassElementsDisplayTo("show_as_default", "none");
        }       

        function showById(elementID, data){
            if (document.getElementById(elementID).style.display != "block"){
                hideDefault();
                document.getElementById(elementID).style.display = "block";

                if (elementID == "soundEditor"){
                    initSoundEditor(data);
                }
            }
        }

        function sendOsc(address, values, types) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                }
            };
            xhr.open('GET', '/send_osc?address=' + address + '&values=' + values.join(';') + '&types=' + types, true);
            xhr.send();
        }

        function sendDataToServer(data) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;
                if (this.status == 200) {
                }
            };
            xhr.open('GET', '/receive_data_from_web?data=' + data);
            xhr.send();
        }

        function savePreset(){
            var element = document.getElementById('savePreset');
            var name = element.querySelector("input[name='presetName']").value;
            var idx = element.querySelector("input[name='presetIdx']").value;
            sendOsc('/save_current_preset', [name, idx], 'str;int');
        }

        function enterQuery(){
            var element = document.getElementById('enterQuery');
            var query = element.querySelector("input[name='query']").value;
            var data = 'query:' + query;
            showWorkingLabel();
            sendDataToServer(data);
        }

        function enterName(){
            var element = document.getElementById('enterName');
            var query = element.querySelector("input[name='query']").value;
            var data = 'query:' + query;
            showWorkingLabel();
            sendDataToServer(data);
        }

    </script>
</head>

<body onload="init();">

    <div id="wrapper">
        <h1>SOURCE</h1>


        <div id="info" class="controls_card show_as_default">
            <p>
                This page will be automatically updated when selecting options in the SOURCE user interface.
            </p>
            {% if freesound_username %}
            <p>
                Logged in as: {{ freesound_username }}
            </p>
            {% endif %}
        </div>

        <div id="workingIndicator">
            Searching Freesound...
        </div>

        <div id="enterQuery" class="controls_card">
            <h2>Enter your query</h2>
            <input name="query" value="" type="text" placeholder=""><br>
            <br>
            <button onclick="enterQuery()">Go!</button>
        </div>

        <div id="enterName" class="controls_card">
            <h2>Enter a name</h2>
            <input name="query" value="" type="text" placeholder=""><br>
            <br>
            <button onclick="enterName()">Go!</button>
        </div>

        <div id="savePreset" class="controls_card show_as_default">
            <h2>Save preset as</h2>
            Number:<input name="presetIdx" value="" type="number"><br>
            <input name="presetName" value="" type="text" placeholder="Preset name">
            <br>
            <button onclick="savePreset()">Save</button>
        </div>

        <div id="transferFiles" class="controls_card show_as_default">
            <h2>Transfer files</h2>
            {% if message %}
                {{message}}
            {% endif %}
            <form method="post" action="." enctype="multipart/form-data">
                <input type="file" name="file[]" multiple="true" required style="background-color:black;">
                <br>
                <input type="submit" value="Submit">                
            </form>
        </div>

        <br>
        <br>
        by Rita & Aurora
    </div>
    
</body>
</html>
